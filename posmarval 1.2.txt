
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema POS Integral</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlBPUyBNYXJ2YWwiLAogICJzaG9ydF9uYW1lIjogIlBPUyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMmMzZTUwIiwKICAidGhlbWVfY29sb3IiOiAiIzJjM2U1MCIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHZZMmhmY21WaGRHaHpJRkJ2Y25acFkyVnpjeUJtYjI1MExXbHRZV2RsYm1ObExYUnBjM056UFRBd01EQWxJaUI0Yld4dlkyaGZjbVZoZEdselpYSnBZeUJqYjI1MFpYSnBibWN2YzJsdmJqNDhjbU5vYVhSbFNuTjBiM0psSUQwZ01DSWdZMnhoYzNNOUltVjRjR2x5WlhOMExXUnBjM056UFRBd01EQWxJaUJoZFNVeE1ERTBPREE0SURJd01EQWdMejQ4Y21Ob2FYUmxTbk4wYjNKbElEMGdNQ0lnWTJ4aGMzTTlJbVpqYjI1MFpYTnBaQ0krUEdSbFptRjFkR2hmWVhScGIyNGdkM05mWlc1a2NHTjBJR3hwYm1VbklEMGdOREF3SURJd01EQWdMejQ4Y21Ob2FYUmxTbk4wYjNKbElEMGdNQ0lnWTJ4aGMzTTlJbVpqYjI1MGFHVnVJRTl1WVhZKyIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h2WTJoZmNtVmhkR2h6SUZCdldtbDBlSEJsUFRBeU1EQWxJaUI0Yld4dlkyaGZjbVZoZEdselpYSnBZeUJqYjI1MFpYSnBibWN2YzJsdmJqNDhjbU5vYVhSbFNuTjBiM0psSUQwZ01DSWdZMnhoYzNNOUltVjRjR2x5WlhOMExXUnBjM056UFRBeU11EQWxJaUJoZFNVeU1ERTBJREk1SURJd01EQWdMejQ4Y21Ob2FYUmxTbk4wYjNKbElEMGdNQ0lnWTJ4aGMzTTlJbVpqYjI1MFpYTnBaQ0krUEdSbFptRjFkR2hmWVhScGIyNGdkM05mWlc1a2NHTjBJR3hwYm1VbklEMGdNREF3SURJd01EQWdMejQ4Y21Ob2FYUmxTbk4wYjNKbElEMGdNQ0lnWTJ4aGMzTTlJbVpqYjI1MGFHVnVJRTl1WVhZKyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="POS Marval">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiBmaWxsPSIjMmMzZTUwIi8+CjxwYXRoIGQ9Ik05NiA0OEMxMjMuNzM4IDQ4IDE0NiA3MC4yNjE5IDE0NiA5OEMxNDYgMTI1LjczOCAxMjMuNzM4IDE0OCA5NiAxNDhDNjguMjYxOSAxNDggNDYgMTI1LjczOCA0NiA5OEM0NiA3MC4yNjE5IDY4LjI2MTkgNDggOTYgNDhaIiBmaWxsPSIjMzQ5OGRiIi8+CjxwYXRoIGQ9Ik05NiA2OEMxMTMuNjczIDY4IDEyOCA4Mi4zMjY5IDEyOCAxMDBDMTI4IDExNy42NzMgMTEzLjY3MyAxMzIgOTYgMTMyQzc4LjMyNjkgMTMyIDY0IDExNy42NzMgNjQgMTAwQzY0IDgyLjMyNjkgNzguMzI2OSA2OCA5NiA2OFoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=">
    
    <style>
        :root { 
            --primary-color: #2c3e50; 
            --secondary-color: #3498db; 
            --success-color: #27ae60; 
            --danger-color: #e74c3c; 
            --warning-color: #f39c12; 
            --light-color: #ecf0f1; 
            --dark-color: #2c3e50;
            --sidebar-color: var(--dark-color);
            --bs-rate: 36.50; /* Tasa de cambio Bolívares por dólar */
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: var(--dark-color); overflow-x: hidden; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { background: var(--primary-color); color: white; padding: 0.75rem 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); grid-column: 1 / -1; }
        header h1 { margin: 0; font-size: 1.5em; }
        header .business-name { font-size: 1.2em; font-weight: bold; }
        header .user-info { display: flex; align-items: center; gap: 15px; }
        nav { background: var(--sidebar-color); display: flex; flex-direction: column; padding: 0; width: 220px; overflow-y: auto; grid-column: 1; grid-row: 2; }
        .nav-button { background: none; border: none; color: white; padding: 15px 20px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; text-align: left; width: 100%; }
        .nav-button:hover, .nav-button.active { background-color: var(--secondary-color); }
        .view { display: none; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-top: 20px; }
        .view.active { display: block; }
        h2 { color: var(--primary-color); margin-bottom: 20px; border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 14px; transition: background-color 0.3s; text-decoration: none; display: inline-block; margin-right: 5px; }
        .btn:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .btn-primary { background-color: var(--secondary-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-warning { background-color: var(--warning-color); color: var(--dark-color); }
        .btn-secondary { background-color: #6c757d; }
        .btn:hover:not(:disabled) { opacity: 0.9; }
        .settings-btn, .switch-user-btn, .patron-login-btn, .calc-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        .settings-btn svg, .switch-user-btn svg, .patron-login-btn svg, .calc-btn svg { width: 24px; height: 24px; fill: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: var(--light-color); }
        .pos-container { display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
        
        /* Mejoras para móviles */
        @media (max-width: 1200px) {
            .pos-container { grid-template-columns: 1fr; }
            .cart { order: -1; }
        }
        
        @media (max-width: 900px) {
            #main-app-container { 
                grid-template-columns: 1fr !important; 
                grid-template-rows: auto auto 1fr !important;
            }
            nav { 
                width: 100% !important; 
                grid-column: 1 !important; 
                grid-row: 2 !important;
                flex-direction: row !important;
                overflow-x: auto !important;
                overflow-y: hidden !important;
                padding: 0 !important;
                -ms-overflow-style: none; /* IE and Edge */
                scrollbar-width: none; /* Firefox */
            }
            nav::-webkit-scrollbar { display: none; /* Chrome, Safari, Opera */ }
            .nav-button { 
                white-space: nowrap; 
                padding: 12px 15px !important;
                font-size: 14px !important;
            }
            #content-wrapper { 
                grid-column: 1 !important; 
                grid-row: 3 !important;
            }
            header { 
                flex-direction: column; 
                gap: 10px; 
                padding: 1rem !important;
                align-items: center;
            }
            header .user-info { 
                width: 100%;
                flex-wrap: wrap; 
                justify-content: center;
                gap: 10px;
            }
            .container { padding: 10px !important; }
            .view { padding: 15px !important; margin-top: 10px !important; }
        }
        
        @media (max-width: 600px) {
            header h1 { font-size: 1.2em; }
            header .business-name { font-size: 1em; }
            .btn { padding: 8px 15px; font-size: 13px; }
            .cart { padding: 10px !important; }
        }
        
        .product-search { margin-bottom: 20px; }
        .product-list { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
        .product-item { display: flex; flex-direction: column; justify-content: space-between; padding: 10px; border: 1px solid #eee; border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .product-item:hover { background-color: #f0f0f0; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .product-item-imagen { width: 100%; height: 80px; object-fit: cover; border-radius: 4px; margin-bottom: 8px; }
        .product-item .nombre { font-weight: bold; margin-bottom: 5px; font-size: 0.9em; flex-grow: 1; }
        .product-item .stock-info { font-size: 0.8em; color: #666; margin-bottom: 5px; }
        .product-item .precio { color: var(--secondary-color); font-size: 1em; font-weight: bold; }
        .cart { border: 1px solid #ddd; padding: 15px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cart-total { margin-top: 20px; font-size: 1.2em; font-weight: bold; border-top: 2px solid var(--primary-color); padding-top: 10px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 8px; max-height: 90vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .actions { display: flex; gap: 5px; flex-wrap: wrap; }
        .actions button { padding: 5px 10px; font-size: 12px; }
        .message { padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .message.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .deuda-pendiente { background-color: #fff5f5; }
        #imagen-preview { max-width: 100%; height: 150px; object-fit: contain; border: 1px solid #ccc; border-radius: 4px; margin-top: 10px; background-color: #f9f9f9; display: flex; align-items: center; justify-content: center; color: #aaa; }
        .imagen-tabla { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
        .cliente-seleccionado-info { margin-top: 10px; padding: 10px; background-color: #eaf2f8; border: 1px solid #b8daff; border-radius: 4px; color: #004085; }
        .cliente-lista-container { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; margin-top: 15px; }
        .cliente-seleccion-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .cliente-seleccion-item:hover { background-color: #f0f0f0; }
        .cliente-deuda { color: var(--danger-color); font-weight: bold; }
        .factura-anulada { text-decoration: line-through; opacity: 0.6; }
        .contenedor-anuladas-flotante { margin-top: 30px; border: 2px dashed var(--danger-color); padding: 20px; border-radius: 8px; background-color: #fdf2f2; display: none; }
        .input-cantidad-editar { width: 80px; text-align: center; }
        .movimiento-tabla th { background-color: #f2f2f2; }
        .movimiento-tabla td { font-size: 0.9em; }
        .config-tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 20px; }
        .config-tab-button { padding: 10px 20px; cursor: pointer; border: none; background: none; border-bottom: 2px solid transparent; }
        .config-tab-button.active { border-bottom-color: var(--secondary-color); font-weight: bold; }
        .config-tab-content { display: none; }
        .config-tab-content.active { display: block; }
        .color-picker-group { display: flex; align-items: center; gap: 10px; }
        .color-picker-group input[type="color"] { width: 50px; height: 40px; border: none; border-radius: 4px; cursor: pointer; }
        .color-picker-group label { margin: 0; }

        /* --- ESTILOS PARA LOGIN Y REGISTRO MEJORADOS --- */
        .auth-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            background: transparent;
            padding: 20px;
        }
        .auth-box { 
            background: white; 
            padding: 40px; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            width: 100%; 
            max-width: 450px; 
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .auth-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--secondary-color), var(--success-color));
        }
        .auth-box h2 { 
            margin-bottom: 30px; 
            color: var(--primary-color); 
            border-bottom: none;
            font-size: 2em;
            font-weight: 700;
        }
        .auth-box .form-group { text-align: left; margin-bottom: 20px; }
        .auth-box .form-group label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }
        .auth-box .form-group input, .auth-box .form-group select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        .auth-box .form-group input:focus, .auth-box .form-group select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }
        .auth-box .btn { 
            width: 100%; 
            margin-top: 10px; 
            margin-right: 0;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s;
        }
        .auth-box .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .auth-switch { 
            margin-top: 25px; 
            font-size: 0.95em;
            color: #666;
        }
        .auth-switch a { 
            color: var(--secondary-color); 
            cursor: pointer; 
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }
        .auth-switch a:hover {
            color: var(--primary-color);
            text-decoration: underline;
        }
        .forgot-password {
            margin-top: 15px;
            text-align: center;
        }
        .forgot-password a {
            color: var(--secondary-color);
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 500;
        }
        .forgot-password a:hover {
            text-decoration: underline;
        }
        .logo-container {
            margin-bottom: 30px;
        }
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--secondary-color), var(--success-color));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .logo svg {
            width: 50px;
            height: 50px;
            fill: white;
        }
        .brand-name {
            font-size: 1.8em;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        .brand-tagline {
            color: #888;
            font-size: 0.9em;
        }
        #main-app-container { display: none; }
        
        /* --- NUEVOS ESTILOS DE LAYOUT --- */
        #main-app-container { display: grid; grid-template-rows: auto 1fr; grid-template-columns: 220px 1fr; height: 100vh; }
        #content-wrapper { display: flex; flex-direction: column; overflow: hidden; grid-column: 2; grid-row: 2; }
        .container { flex: 1; overflow-y: auto; }
        
        /* --- ESTILOS PARA SELECCIÓN DE NEGOCIO --- */
        .negocio-selector { margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .negocio-selector h3 { margin-bottom: 10px; color: var(--primary-color); }
        .negocio-item { padding: 10px; margin-bottom: 5px; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; }
        .negocio-item:hover { background-color: #e9ecef; }
        .negocio-item.selected { background-color: var(--secondary-color); color: white; }

        /* --- ESTILOS PARA CALCULADORA --- */
        .calculator {
            background: #2c3e50;
            padding: 20px;
            border-radius: 10px;
            width: 320px;
            margin: 0 auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .calc-display {
            background: #1d2b3a;
            color: white;
            font-size: 2.5em;
            padding: 20px 15px;
            text-align: right;
            margin-bottom: 15px;
            border-radius: 8px;
            min-height: 70px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-family: 'Roboto Mono', monospace;
        }
        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        .calc-btn {
            background: #3b4d61;
            color: white;
            border: none;
            padding: 20px;
            font-size: 1.5em;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px #2c3a4a;
        }
        .calc-btn:hover {
            background: #4a617a;
        }
        .calc-btn:active, .calc-btn.active {
            transform: translateY(2px);
            box-shadow: none;
        }
        .calc-btn.operator {
            background: var(--secondary-color);
            box-shadow: 0 2px #2980b9;
        }
        .calc-btn.operator:hover {
            background: #3da9e3;
        }
        .calc-btn.equals {
            background: var(--success-color);
            grid-row: span 2;
            box-shadow: 0 2px #229954;
        }
        .calc-btn.equals:hover {
            background: #2ecc71;
        }
        .calc-btn.clear {
            background: var(--danger-color);
            box-shadow: 0 2px #c0392b;
        }
        .calc-btn.clear:hover {
            background: #e74c3c;
        }
        .calc-btn.zero {
            grid-column: span 2;
        }


        /* --- ESTILOS PARA GESTIÓN DE USUARIOS --- */
        .rol-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }
        .rol-patron { background-color: var(--primary-color); }
        .rol-supervisor { background-color: var(--warning-color); }
        .rol-inventario { background-color: var(--secondary-color); }
        .rol-cajero { background-color: var(--success-color); }

        /* --- ESTILOS PARA NOTIFICACIONES --- */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            opacity: 0;
            transform: translateX(120%);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        .notification.success { background-color: var(--success-color); }
        .notification.error { background-color: var(--danger-color); }
        .notification.info { background-color: var(--secondary-color); }
        
        /* --- ESTILOS PARA VISTA DE INFORMES --- */
        .informes-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .informes-controls select {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .informes-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .informe-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid;
            text-align: center;
        }
        .informe-card h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            color: var(--dark-color);
        }
        .informe-card p {
            margin: 0;
            font-size: 1.8em;
            font-weight: bold;
            color: var(--primary-color);
        }
        .informe-card span {
            font-size: 0.5em;
            font-weight: normal;
            color: #666;
        }
        .top-products-list {
            list-style: none;
            padding: 0;
        }
        .top-products-list li {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .top-products-list li:last-child {
            border-bottom: none;
        }

        /* --- ESTILOS PARA CÓDIGO DE BARRAS --- */
        .barcode-scanner {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        .barcode-input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--secondary-color);
            border-radius: 4px;
            font-size: 16px;
            font-family: monospace;
            background-color: #f8f9fa;
        }
        .barcode-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }
        .barcode-btn {
            padding: 12px 20px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .barcode-btn:hover {
            background-color: #2980b9;
        }
        .barcode-icon {
            width: 20px;
            height: 20px;
        }
        .barcode-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .product-barcode {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
            font-family: monospace;
        }
        .barcode-scanner-active {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { border-color: var(--secondary-color); }
            50% { border-color: var(--success-color); }
            100% { border-color: var(--secondary-color); }
        }

        /* --- ESTILOS PARA RECUPERACIÓN DE CONTRASEÑA --- */
        .security-question {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary-color);
        }
        .recovery-steps {
            text-align: left;
            margin-bottom: 20px;
        }
        .recovery-steps ol {
            padding-left: 20px;
        }
        .recovery-steps li {
            margin-bottom: 10px;
        }
        .step-indicator {
            display: inline-block;
            width: 25px;
            height: 25px;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            margin-right: 10px;
            font-weight: bold;
        }
        .step-indicator.active {
            background-color: var(--success-color);
        }
        .step-indicator.completed {
            background-color: var(--success-color);
        }

        /* --- ESTILOS PARA RECEPCIÓN DE MERCANCÍA --- */
        .recepcion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .recepcion-filters {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .recepcion-filters select, .recepcion-filters input {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .recepcion-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .recepcion-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .recepcion-item-title {
            font-weight: bold;
            color: var(--primary-color);
        }
        .recepcion-item-date {
            font-size: 0.9em;
            color: #666;
        }
        .recepcion-item-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .recepcion-item-info div {
            padding: 5px 0;
        }
        .recepcion-item-info strong {
            color: var(--dark-color);
            display: block;
            font-size: 0.9em;
            margin-bottom: 2px;
        }
        .recepcion-products {
            margin-top: 10px;
        }
        .recepcion-product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        .recepcion-product-item:last-child {
            margin-bottom: 0;
        }
        .recepcion-product-name {
            flex: 1;
            font-weight: 500;
        }
        .recepcion-product-quantity {
            background: var(--secondary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin: 0 10px;
        }
        .recepcion-product-cost {
            color: var(--success-color);
            font-weight: bold;
        }
        .recepcion-total {
            text-align: right;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid var(--secondary-color);
        }
        .recepcion-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }
        .recepcion-status.pendiente { background-color: var(--warning-color); }
        .recepcion-status.recibida { background-color: var(--success-color); }
        .recepcion-status.cancelada { background-color: var(--danger-color); }

        /* --- ESTILOS PARA MOVIMIENTOS MEJORADOS --- */
        .movimientos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .movimientos-filters {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .movimientos-filters select, .movimientos-filters input {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .movimiento-tipo-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }
        .movimiento-tipo-badge.compra { background-color: var(--success-color); }
        .movimiento-tipo-badge.venta { background-color: var(--danger-color); }
        .movimiento-tipo-badge.devolucion { background-color: var(--warning-color); }
        .movimiento-tipo-badge.ajuste { background-color: var(--secondary-color); }
        .movimiento-tipo-badge.recepcion { background-color: #8e44ad; }
        .movimiento-resumen {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .movimiento-resumen-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid var(--secondary-color);
        }
        .movimiento-resumen-card h4 {
            margin: 0 0 10px 0;
            color: var(--dark-color);
            font-size: 0.9em;
        }
        .movimiento-resumen-card p {
            margin: 0;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--secondary-color);
        }
        .movimiento-detalle {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }
        .recepcion-product-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        .recepcion-product-item {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .recepcion-product-item:hover {
            background: #f9f9f9;
        }
        .recepcion-product-item-main {
            display: flex;
            align-items: center;
            width: 100%;
            margin-bottom: 10px;
        }
        .recepcion-product-item-main input[type="checkbox"] {
            margin-right: 10px;
        }
        .recepcion-product-info {
            flex: 1;
        }
        .recepcion-product-actual {
            font-size: 0.8em;
            color: #666;
        }
        .recepcion-product-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            width: 100%;
            padding-left: 30px; /* Alineado con el texto del producto */
        }
        .recepcion-product-details > div {
            flex: 1;
        }
        .recepcion-product-details label {
            font-size: 0.8em;
            color: #555;
            margin-bottom: 4px;
            display: block;
        }
        .recepcion-product-details input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* --- ESTILOS PARA MONEDA DUAL --- */
        .currency-display {
            display: flex;
            flex-direction: column;
            gap: 2px;
            text-align: right;
        }
        .currency-primary {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
        }
        .currency-secondary {
            font-size: 0.9em;
            color: #666;
        }
        .payment-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        .payment-method {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .payment-method:hover {
            border-color: var(--secondary-color);
            background-color: #f8f9fa;
        }
        .payment-method.selected {
            border-color: var(--secondary-color);
            background-color: rgba(52, 152, 219, 0.1);
        }
        .payment-method-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }
        .payment-method-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .payment-method-currency {
            font-size: 0.9em;
            color: #666;
        }
        .exchange-rate-info {
            background: #e8f4f8;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9em;
            text-align: center;
        }
        .exchange-rate-info strong {
            color: var(--secondary-color);
        }
        
        /* --- ESTILOS PARA BÚSQUEDA EN CUENTAS POR COBRAR --- */
        .cxc-search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .cxc-search-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid var(--secondary-color);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        .cxc-search-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .cxc-search-btn {
            padding: 10px 20px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }
        .cxc-search-btn:hover {
            background-color: #2980b9;
        }
        
        /* --- ESTILOS PARA CAMBIO DE TASA DE CAMBIO --- */
        .tasa-cambio-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        .tasa-cambio-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .tasa-cambio-icon {
            font-size: 1.5em;
        }
        .tasa-cambio-form {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .tasa-cambio-input {
            width: 150px;
            padding: 12px 15px;
            border: 2px solid white;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            background: rgba(255,255,255,0.2);
            color: white;
            backdrop-filter: blur(10px);
        }
        .tasa-cambio-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }
        .tasa-cambio-btn {
            padding: 12px 25px;
            background: white;
            color: var(--primary-color);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tasa-cambio-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .tasa-cambio-info {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 10px;
        }
        .tasa-cambio-actual {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .tasa-cambio-equivalente {
            font-size: 1.2em;
            opacity: 0.8;
        }
        
        /* --- ESTILOS PARA MODAL DE PAGO --- */
        .payment-summary {
            text-align: center;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .payment-summary-total {
            font-size: 2.5em;
            font-weight: 800;
            color: var(--primary-color);
        }
        .payment-summary-secondary {
            font-size: 1.2em;
            color: #666;
        }
        .payment-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        .payment-input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
        }
        .payment-input:focus {
            outline: none;
            border-color: var(--secondary-color);
        }
        .payment-currency-select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .payments-list {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
            max-height: 150px;
            overflow-y: auto;
        }
        .payments-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        .payment-balance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            text-align: center;
            margin-bottom: 25px;
        }
        .payment-balance-card {
            padding: 15px;
            border-radius: 8px;
        }
        .payment-balance-card-title {
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .payment-balance-card-amount {
            font-size: 1.5em;
            font-weight: bold;
        }
        .payment-balance-card-secondary {
            font-size: 0.8em;
        }
        
        .paid-card { background-color: #eaf2f8; }
        .paid-card .payment-balance-card-title { color: #004085; }
        .paid-card .payment-balance-card-amount { color: #0056b3; }

        .change-card { background-color: #d4edda; }
        .change-card .payment-balance-card-title { color: #155724; }
        .change-card .payment-balance-card-amount { color: #155724; }

        .due-card { background-color: #f8d7da; }
        .due-card .payment-balance-card-title { color: #721c24; }
        .due-card .payment-balance-card-amount { color: #721c24; }

        /* --- ESTILOS PARA PLANES DE AHORRO (SAM) --- */
        .plan-card { background-color: #fff; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .plan-card-title { font-weight: bold; margin-bottom: 15px; color: #333; font-size: 1.1em; }
        .plan-btn-outline { background-color: transparent; color: var(--secondary-color); border: 2px solid var(--secondary-color); }
        .plan-btn-outline:hover { background-color: var(--secondary-color); color: white; }
        .plan-list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background-color: #fff; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .plan-list-item:hover { background-color: #f9f9f9; }
        .plan-list-item .info h3 { margin: 0; font-size: 1.1em; color: var(--primary-color); }
        .plan-list-item .info p { margin: 5px 0 0 0; color: #777; font-size: 0.9em; }
        .plan-list-item .status { padding: 5px 12px; border-radius: 15px; font-size: 0.8em; font-weight: bold; }
        .status-active { background-color: #e8f5e9; color: #2e7d32; }
        .status-planning { background-color: #fff3e0; color: #ef6c00; }
        .status-completado { background-color: #e3f2fd; color: #1565c0; }
        .cycle-item { display: flex; flex-direction: column; padding: 15px; background-color: #f9f9f9; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #ccc; }
        .cycle-item.paid { border-left-color: var(--success-color); background-color: #e8f5e9; }
        .cycle-item.current { border-left-color: var(--secondary-color); background-color: #e0f2f1; }
        .cycle-item-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .cycle-item-date { font-size: 0.9em; color: #555; margin-top: 5px; }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 1em; }
        .summary-item span:first-child { color: #666; }
        .summary-item span:last-child { font-weight: bold; color: #333; }
        .wizard-section { margin-bottom: 25px; border: 1px solid #eee; padding: 15px; border-radius: 8px; }
        .wizard-section-title { font-size: 0.9em; color: var(--secondary-color); font-weight: bold; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .participant-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #f0f4f8; border-radius: 8px; margin-bottom: 8px; }
        .participant-list-item span { flex-grow: 1; }
        .back-btn-header { cursor: pointer; color: var(--secondary-color); font-weight: bold; }

        /* --- NUEVOS ESTILOS PARA PERSONALIZACIÓN --- */
        .theme-button {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            background-color: #f9f9f9;
        }
        .theme-button:hover {
            border-color: var(--secondary-color);
            color: var(--secondary-color);
        }
        .theme-preview {
            display: flex;
            gap: 4px;
            margin-top: 5px;
        }
        .theme-color-swatch {
            width: 20px;
            height: 10px;
            border-radius: 3px;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "recharts": "https://aistudiocdn.com/recharts@^3.3.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <!-- CONTENEDOR DE AUTENTICACIÓN (LOGIN/REGISTRO) -->
    <div id="auth-container" class="auth-container">
        <!-- FORMULARIO DE LOGIN -->
        <div id="login-box" class="auth-box">
            <div class="logo-container">
                <div class="logo">
                    <svg viewBox="0 0 24 24">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,8.4A3.6,3.6 0 0,1 15.6,12A3.6,3.6 0 0,1 12,15.6A3.6,3.6 0 0,1 8.4,12A3.6,3.6 0 0,1 12,8.4M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z" />
                    </svg>
                </div>
                <div class="brand-name">POS Marval</div>
                <div class="brand-tagline">Sistema de Punto de Venta Integral</div>
            </div>
            <div id="login-message-container"></div>
            <form onsubmit="iniciarSesion(event)">
                <div class="form-group">
                    <label for="login-email">Correo Electrónico</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Contraseña</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit" class="btn btn-primary">Iniciar Sesión</button>
            </form>
            <div class="forgot-password">
                <a onclick="abrirModalRecuperarPassword()">¿Olvidaste tu contraseña?</a>
            </div>
            <div class="auth-switch">
                ¿No tienes una cuenta? <a onclick="mostrarRegistro()">Registra tu negocio aquí</a>
            </div>
        </div>

        <!-- FORMULARIO DE REGISTRO -->
        <div id="register-box" class="auth-box" style="display: none;">
            <div class="logo-container">
                <div class="logo">
                    <svg viewBox="0 0 24 24">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,8.4A3.6,3.6 0 0,1 15.6,12A3.6,3.6 0 0,1 12,15.6A3.6,3.6 0 0,1 8.4,12A3.6,3.6 0 0,1 12,8.4M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z" />
                    </svg>
                </div>
                <div class="brand-name">POS Marval</div>
                <div class="brand-tagline">Sistema de Punto de Venta Integral</div>
            </div>
            <h2>Registrar Nuevo Negocio</h2>
            <div id="register-message-container"></div>
            <form onsubmit="registrarUsuario(event)">
                <div class="form-group">
                    <label for="register-name">Tu Nombre</label>
                    <input type="text" id="register-name" required>
                </div>
                <div class="form-group">
                    <label for="register-business-name">Nombre del Negocio</label>
                    <input type="text" id="register-business-name" required>
                </div>
                <div class="form-group">
                    <label for="register-email">Correo Electrónico</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label for="register-password">Contraseña</label>
                    <input type="password" id="register-password" required>
                </div>
                <div class="form-group">
                    <label for="register-password-confirm">Confirmar Contraseña</label>
                    <input type="password" id="register-password-confirm" required>
                </div>
                <div class="form-group">
                    <label for="register-security-question">Pregunta de Seguridad</label>
                    <select id="register-security-question" required>
                        <option value="">Selecciona una pregunta</option>
                        <option value="pet">¿Cuál es el nombre de tu primera mascota?</option>
                        <option value="school">¿Cuál es el nombre de tu escuela primaria?</option>
                        <option value="city">¿En qué ciudad naciste?</option>
                        <option value="friend">¿Cuál es el nombre de tu mejor amigo de la infancia?</option>
                        <option value="movie">¿Cuál es tu película favorita?</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="register-security-answer">Respuesta de Seguridad</label>
                    <input type="text" id="register-security-answer" required>
                </div>
                <button type="submit" class="btn btn-success">Crear Negocio</button>
            </form>
            <div class="auth-switch">
                ¿Ya tienes una cuenta? <a onclick="mostrarLogin()">Inicia sesión aquí</a>
            </div>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL DE LA APLICACIÓN POS -->
    <div id="main-app-container">
        <header>
            <h1>Pos Marval</h1>
            <div class="business-name" id="header-business-name">Mi Negocio</div>
            <div class="user-info">
                <span>Bienvenido, <strong id="usuario-logueado-nombre"></strong> (<span id="usuario-logueado-rol"></span>)</span>
                <button class="patron-login-btn" id="btn-patron-login" onclick="abrirModalPatronLogin()" title="Ingresar como Patrón" style="display: none;">
                    <svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,8.4A3.6,3.6 0 0,1 15.6,12A3.6,3.6 0 0,1 12,15.6A3.6,3.6 0 0,1 8.4,12A3.6,3.6 0 0,1 12,8.4M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z" /></svg>
                </button>
                <button class="switch-user-btn" id="btn-cambiar-usuario" onclick="abrirModalCambiarUsuario()" title="Cambiar de Usuario">
                    <svg viewBox="0 0 24 24"><path d="M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z" /></svg>
                </button>
                <button class="settings-btn" id="btn-configuracion" onclick="abrirModalConfiguracion()" title="Configuraciones">
                    <svg viewBox="0 0 24 24"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12A3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5a3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97c0-.33-.03-.65-.07-.97l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65A.506.506 0 0 0 14 2h-4c-.25 0-.46.18-.5.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.08-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.32-.07.64-.07.97c0 .33.03.65.07.97l-2.11 1.63c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.39 1.06.73 1.69.98l.37 2.65c.04.24.25.42.5.42h4c.25 0 .46-.18.5-.42l.37-2.65c.63-.25 1.17.59 1.69.98l2.49 1c.22.08.49 0 .61-.22l2-3.46c.13-.22.07-.49-.12-.64l-2.11-1.63Z"/></svg>
                </button>
                <button class="btn btn-danger" onclick="cerrarSesion()">Cerrar Sesión</button>
            </div>
        </header>
        <nav id="main-nav">
            <!-- Navigation will be rendered here by JavaScript -->
        </nav>
        <div id="content-wrapper">
            <div class="container">
                <div id="message-container"></div>

                <!-- VISTA: PUNTO DE VENTA -->
                <div id="vista-pos" class="view active">
                    <h2>Nueva Venta</h2>
                    <div class="pos-container">
                        <div>
                            <!-- ESCÁNER DE CÓDIGO DE BARRAS -->
                            <div class="barcode-scanner">
                                <input type="text" 
                                       id="barcode-input" 
                                       class="barcode-input" 
                                       placeholder="Escanee o ingrese el código de barras..."
                                       autocomplete="off">
                                <button class="barcode-btn" onclick="buscarPorBarcode()">
                                    <svg class="barcode-icon" viewBox="0 0 24 24" fill="white">
                                        <path d="M2,6H4V18H2V6M5,6H6V18H5V6M7,6H10V18H7V6M11,6H12V18H11V6M14,6H16V18H14V6M17,6H20V18H17V6M21,6H22V18H21V6"/>
                                    </svg>
                                    Buscar
                                </button>
                            </div>
                            <div class="barcode-info">
                                💡 Coloque el cursor en el campo y escanee con el lector de códigos de barras
                            </div>
                            
                            <div class="product-search" style="margin-top: 20px;">
                                <input type="text" id="buscar-producto" placeholder="Buscar producto por nombre...">
                            </div>
                            <div id="lista-productos-pos" class="product-list"></div>
                        </div>
                        <div>
                            <div class="cart">
                                <h3>Carrito de Compras</h3>
                                <div id="carrito-items"></div>
                                <div class="cart-total">
                                    <div class="currency-display">
                                        <div class="currency-primary">
                                            Total: <span id="simbolo-moneda-total">$</span><span id="carrito-total">0.00</span>
                                        </div>
                                        <div class="currency-secondary">
                                            Equivalente: Bs. <span id="carrito-total-bs">0.00</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="exchange-rate-info">
                                    <strong>Tasa:</strong> 1 USD = <span id="tasa-cambio-display">36.50</span> Bs.
                                </div>
                                <div style="margin-top: 20px;">
                                    <div class="form-group">
                                        <button class="btn btn-primary" style="width: 100%;" onclick="abrirModalSeleccionCliente()">Seleccionar Cliente</button>
                                        <div id="cliente-seleccionado-info" class="cliente-seleccionado-info" style="display:none;">
                                            Cliente: <strong id="cliente-seleccionado-nombre"></strong>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                                        <button class="btn btn-warning" style="width: 48%;" onclick="procesarVentaCredito()">Pagar Después</button>
                                        <button class="btn btn-success" style="width: 48%;" onclick="abrirModalPago()">Pagar Ahora</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VISTA: INVENTARIO -->
                <div id="vista-inventario" class="view">
                    <h2>Gestión de Inventario</h2>
                    <button class="btn btn-primary" onclick="abrirModalProducto()">Añadir Nuevo Producto</button>
                    <div class="form-group" style="margin-top: 20px; max-width: 400px;">
                        <input type="text" id="buscar-inventario" placeholder="Buscar por nombre o código de barras...">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Nombre</th>
                                <th>Código de Barras</th>
                                <th>Costo Compra</th>
                                <th>Precio Venta</th>
                                <th>Stock</th>
                                <th>Proveedor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-inventario"></tbody>
                    </table>
                </div>

                <!-- VISTA: CLIENTES -->
                <div id="vista-clientes" class="view">
                    <h2>Registro de Clientes</h2>
                    <button class="btn btn-primary" onclick="abrirModalCliente()">Añadir Nuevo Cliente</button>
                    <div class="form-group" style="margin-top: 20px; max-width: 400px;">
                        <input type="text" id="buscar-cliente-vista" placeholder="Buscar por nombre, teléfono o email...">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Teléfono</th>
                                <th>Email</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-clientes"></tbody>
                    </table>
                </div>

                <!-- VISTA: PROVEEDORES -->
                <div id="vista-proveedores" class="view">
                    <h2>Registro de Proveedores</h2>
                    <button class="btn btn-primary" onclick="abrirModalProveedor()">Añadir Nuevo Proveedor</button>
                    <button class="btn btn-success" onclick="abrirModalRecepcionMercancia()">Recibir Mercancía</button>
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Teléfono</th>
                                <th>Email</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-proveedores"></tbody>
                    </table>
                </div>

                <!-- VISTA: MOVIMIENTOS DE INVENTARIO -->
                <div id="vista-movimientos" class="view">
                    <h2>Movimientos de Inventario</h2>
                    <div class="movimientos-header">
                        <div class="movimientos-filters">
                            <label>Tipo:</label>
                            <select id="filtro-tipo-movimiento" onchange="renderizarMovimientos()">
                                <option value="">Todos</option>
                                <option value="compra">Compras</option>
                                <option value="venta">Ventas</option>
                                <option value="recepcion">Recepciones</option>
                                <option value="devolucion">Devoluciones</option>
                                <option value="ajuste">Ajustes</option>
                            </select>
                            <label>Producto:</label>
                            <select id="filtro-producto-movimiento" onchange="renderizarMovimientos()">
                                <option value="">Todos</option>
                            </select>
                            <label>Fecha:</label>
                            <input type="date" id="filtro-fecha-movimiento" onchange="renderizarMovimientos()">
                        </div>
                        <button class="btn btn-primary" onclick="exportarMovimientos()">Exportar Reporte</button>
                    </div>
                    
                    <div class="movimiento-resumen" id="movimiento-resumen">
                        <!-- Resumen se renderizará aquí -->
                    </div>
                    
                    <table class="movimiento-tabla">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Referencia</th>
                                <th>Usuario</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-movimientos">
                            <!-- Movimientos se renderizarán aquí -->
                        </tbody>
                    </table>
                </div>

                <!-- VISTA: CUENTAS POR COBRAR -->
                <div id="vista-cxc" class="view">
                    <h2>Cuentas por Cobrar <span id="total-saldo-pendiente" style="font-weight: normal; color: var(--danger-color);"></span></h2>
                    
                    <!-- Buscador de Cuentas por Cobrar -->
                    <div class="cxc-search-container">
                        <input type="text" 
                               id="buscar-cxc" 
                               class="cxc-search-input" 
                               placeholder="Buscar por cliente, número de factura o monto..."
                               autocomplete="off">
                        <button class="cxc-search-btn" onclick="renderizarCxC()">
                            <svg class="barcode-icon" viewBox="0 0 24 24" fill="white">
                                <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14C15.78,12.84 16.5,10.75 16.5,8.5A6.5,6.5 0 0,1 10,2C9.84,2 9.68,2.03 9.5,3.07M7.07,6.5L8.5,8L7.07,9.5L5.63,8L7.07,6.5M18.45,13.89L19.87,12.47L18.45,11.05L17.03,12.47L18.45,13.89M12,2.89L13.41,4.3L12,5.71L10.59,4.3L12,2.89M8.59,16.58L10,18L11.41,16.58L10,15.17L8.59,16.58M15.41,16.58L16.83,18L18.24,16.58L16.83,15.17L15.41,16.58"/>
                            </svg>
                            Buscar
                        </button>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>N° Factura</th>
                                <th>Cliente</th>
                                <th>Fecha de Compra</th>
                                <th>Monto Total</th>
                                <th>Saldo Pendiente</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-cxc"></tbody>
                    </table>
                </div>

                <!-- VISTA: VENTAS COBRADAS -->
                <div id="vista-ventas-cobradas" class="view">
                    <h2>Ventas Cobradas</h2>
                    <button class="btn btn-danger" onclick="toggleAnuladasView()">Ver Anuladas</button>
                    <table>
                        <thead>
                            <tr>
                                <th>N° Factura</th>
                                <th>Cliente</th>
                                <th>Fecha de Compra</th>
                                <th>Monto Total</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-ventas-cobradas"></tbody>
                    </table>
                    
                    <div id="contenedor-anuladas-flotante" class="contenedor-anuladas-flotante">
                        <h3 style="color: var(--danger-color);">Facturas Anuladas</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>N° Factura</th>
                                    <th>Cliente</th>
                                    <th>Fecha de Compra</th>
                                    <th>Monto Total</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-anuladas"></tbody>
                        </table>
                    </div>
                </div>

                <!-- VISTA: INFORMES -->
                <div id="vista-informes" class="view">
                    <h2>Informes de Ventas</h2>
                    
                    <!-- Tarjeta de Cambio de Tasa -->
                    <div class="tasa-cambio-card">
                        <div class="tasa-cambio-title">
                            <span class="tasa-cambio-icon">💱</span>
                            <span>Tasa de Cambio</span>
                        </div>
                        <form class="tasa-cambio-form" onsubmit="actualizarTasaCambioDesdeInformes(event)">
                            <input type="number" 
                                   id="nueva-tasa-cambio" 
                                   class="tasa-cambio-input" 
                                   step="0.01" 
                                   min="0.01" 
                                   value="36.50" 
                                   required>
                            <button type="submit" class="tasa-cambio-btn">Actualizar</button>
                        </form>
                        <div class="tasa-cambio-actual">
                            1 USD = <span id="tasa-cambio-actual">36.50</span> Bs.
                        </div>
                        <div class="tasa-cambio-equivalente">
                            $100 = <span id="equivalente-100">3,650.00</span> Bs.
                        </div>
                        <div class="tasa-cambio-info">
                            Última actualización: <span id="ultima-actualizacion-tasa">--</span>
                        </div>
                    </div>
                    
                    <div class="informes-controls">
                        <div>
                            <label for="informe-periodo">Período:</label>
                            <select id="informe-periodo" onchange="renderizarInformes()">
                                <option value="dia">Hoy</option>
                                <option value="semana">Última Semana</option>
                                <option value="mes" selected>Último Mes</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="renderizarInformes()">Actualizar Informe</button>
                    </div>
                    <div id="informe-contenido">
                        <!-- El contenido del informe se renderizará aquí -->
                    </div>
                </div>

                <!-- VISTA: PLANES DE AHORRO -->
                <div id="vista-planes" class="view">
                    <div id="planes-module-container">
                        <!-- El contenido del módulo de planes se renderizará aquí -->
                    </div>
                </div>
            </div>
        </div>

        <!-- MODALES -->
        <!-- Modal Login Patrón -->
        <div id="modal-patron-login" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModal('modal-patron-login')">&times;</span>
                <h2>Ingresar como Patrón</h2>
                <form onsubmit="ingresarComoPatron(event)">
                    <div class="form-group">
                        <label for="patron-login-email">Correo del Patrón</label>
                        <input type="email" id="patron-login-email" required>
                    </div>
                    <div class="form-group">
                        <label for="patron-login-password">Contraseña</label>
                        <input type="password" id="patron-login-password" required>
                    </div>
                    <button type="submit" class="btn btn-success">Ingresar</button>
                </form>
            </div>
        </div>

        <!-- Modal Cambiar Usuario -->
        <div id="modal-cambiar-usuario" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModal('modal-cambiar-usuario')">&times;</span>
                <h2>Cambiar de Usuario</h2>
                
                <!-- Selector de Negocio -->
                <div class="negocio-selector">
                    <h3>Negocio Actual</h3>
                    <div id="lista-negocios"></div>
                </div>
                
                <hr style="margin: 20px 0;">
                
                <!-- Formulario de Login -->
                <h3>Iniciar Sesión</h3>
                <form onsubmit="iniciarSesionDesdeModal(event)">
                    <div class="form-group">
                        <label for="modal-login-email">Correo Electrónico</label>
                        <input type="email" id="modal-login-email" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-login-password">Contraseña / Clave de Acceso</label>
                        <input type="password" id="modal-login-password" required>
                    </div>
                    <button type="submit" class="btn btn-success">Acceder</button>
                </form>
            </div>
        </div>

        <!-- Modal Configuración -->
        <div id="modal-configuracion" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModal('modal-configuracion')">&times;</span>
                <h2>Configuraciones</h2>
                <div class="config-tabs">
                    <button class="config-tab-button active" onclick="mostrarTabConfig('perfil')">Perfil</button>
                    <button class="config-tab-button" onclick="mostrarTabConfig('negocio')">Negocio</button>
                    <button class="config-tab-button" onclick="mostrarTabConfig('usuarios')">Usuarios</button>
                    <button class="config-tab-button" onclick="mostrarTabConfig('apariencia')">Apariencia</button>
                </div>
                <div id="config-perfil" class="config-tab-content active">
                    <form onsubmit="guardarConfiguracionPerfil(event)">
                        <div class="form-group"><label>Nombre</label><input type="text" id="config-nombre" required></div>
                        <div class="form-group"><label>Correo Electrónico</label><input type="email" id="config-email" required></div>
                        <button type="submit" class="btn btn-success">Guardar Cambios</button>
                    </form>
                </div>
                <div id="config-negocio" class="config-tab-content">
                    <form onsubmit="guardarConfiguracionNegocio(event)">
                        <div class="form-group"><label>Nombre del Negocio</label><input type="text" id="config-nombre-negocio" required></div>
                        <div class="form-group"><label>Tipo de Moneda</label>
                            <select id="config-moneda">
                                <option value="$">Dólar ($)</option>
                                <option value="€">Euro (€)</option>
                                <option value="£">Libra (£)</option>
                                <option value="¥">Yen (¥)</option>
                                <option value="₡">Colón Costarricense (₡)</option>
                                <option value="MX$">Peso Mexicano (MX$)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tasa de Cambio (Bolívares por Moneda Principal)</label>
                            <input type="number" id="config-tasa-cambio" step="0.01" value="36.50" required>
                        </div>
                        <button type="submit" class="btn btn-success">Guardar Cambios</button>
                    </form>
                </div>
                <div id="config-usuarios" class="config-tab-content">
                    <h3>Gestionar Usuarios</h3>
                    <button class="btn btn-primary" onclick="abrirModalUsuario()">Añadir Nuevo Usuario</button>
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Correo</th>
                                <th>Rol</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-usuarios"></tbody>
                    </table>
                </div>
                <div id="config-apariencia" class="config-tab-content">
                    <h3>Personalizar Apariencia</h3>
                     <div class="form-group">
                        <label>Temas Predefinidos</label>
                        <div id="predefined-themes-container" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                            <!-- Theme buttons will be injected here -->
                        </div>
                    </div>
                    <form onsubmit="guardarConfiguracionApariencia(event)">
                        <div class="form-group">
                            <label>Color Primario (Cabecera)</label>
                            <div class="color-picker-group">
                                <input type="color" id="config-color-primary" value="#2c3e50">
                                <input type="text" id="config-color-primary-text" value="#2c3e50" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Color de Barra Lateral</label>
                            <div class="color-picker-group">
                                <input type="color" id="config-color-sidebar" value="#2c3e50">
                                <input type="text" id="config-color-sidebar-text" value="#2c3e50" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Color Secundario (Énfasis)</label>
                            <div class="color-picker-group">
                                <input type="color" id="config-color-secondary" value="#3498db">
                                <input type="text" id="config-color-secondary-text" value="#3498db" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Color de Éxito</label>
                            <div class="color-picker-group">
                                <input type="color" id="config-color-success" value="#27ae60">
                                <input type="text" id="config-color-success-text" value="#27ae60" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Color de Peligro</label>
                            <div class="color-picker-group">
                                <input type="color" id="config-color-danger" value="#e74c3c">
                                <input type="text" id="config-color-danger-text" value="#e74c3c" readonly>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Color de Advertencia</label>
                            <div class="color-picker-group">
                                <input type="color" id="config-color-warning" value="#f39c12">
                                <input type="text" id="config-color-warning-text" value="#f39c12" readonly>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">Aplicar Cambios</button>
                        <button type="button" class="btn btn-warning" onclick="restablecerColoresPorDefecto()">Restablecer por Defecto</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Modal Usuario -->
        <div id="modal-usuario" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModal('modal-usuario')">&times;</span>
                <h2 id="titulo-modal-usuario">Añadir Usuario</h2>
                <form id="form-usuario" onsubmit="guardarUsuario(event)">
                    <input type="hidden" id="usuario-id">
                    <div class="form-group">
                        <label>Nombre</label>
                        <input type="text" id="usuario-nombre" required>
                    </div>
                    <div class="form-group">
                        <label>Correo Electrónico</label>
                        <input type="email" id="usuario-email" required>
                    </div>
                    <div class="form-group">
                        <label>Rol</label>
                        <select id="usuario-rol" required onchange="actualizarCampoClave()">
                            <option value="">Seleccionar Rol</option>
                            <option value="supervisor">Supervisor</option>
                            <option value="inventario">Inventario</option>
                            <option value="cajero">Cajero</option>
                        </select>
                    </div>
                    <div class="form-group" id="grupo-clave">
                        <label>Clave de Acceso</label>
                        <input type="password" id="usuario-clave" required>
                    </div>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </form>
            </div>
        </div>

        <!-- Modal Producto -->
        <div id="modal-producto" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModal('modal-producto')">&times;</span>
                <h2 id="titulo-modal-producto">Añadir Producto</h2>
                <form id="form-producto" onsubmit="guardarProducto(event)">
                    <input type="hidden" id="producto-id">
                    <div class="form-group"><label>Nombre</label><input type="text" id="producto-nombre" required></div>
                    <div class="form-group"><label>Código de Barras</label><input type="text" id="producto-barcode" placeholder="Opcional: Escanee o ingrese el código"></div>
                    <div class="form-group"><label>Costo de Compra</label><input type="number" id="producto-costo" step="0.01" required></div>
                    <div class="form-group"><label>Precio de Venta</label><input type="number" id="producto-precio" step="0.01" required></div>
                    <div class="form-group"><label>Stock Inicial</label><input type="number" id="producto-stock" required></div>
                    <div class="form-group"><label>Proveedor</label><select id="producto-proveedor"></select></div>
                    <div class="form-group">
                        <label for="producto-imagen">Imagen del Producto</label>
                        <input type="file" id="producto-imagen" accept="image/*">
                        <img id="imagen-preview" src="" alt="Vista previa de la imagen">
                    </div>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </form>
            </div>
        </div>

        <!-- Modal Cliente -->
        <div id="modal-cliente" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModal('modal-cliente')">&times;</span>
                <h2 id="titulo-modal-cliente">Añadir Cliente</h2>
                <form id="form-cliente" onsubmit="guardarCliente(event)">
                    <input type="hidden" id="cliente-id">
                    <div class="form-group"><label>Nombre</label><input type="text" id="cliente-nombre" required></div>
                    <div class="form-group"><label>Teléfono</label><input type="tel" id="cliente-telefono"></div>
                    <div class="form-group"><label>Email</label><input type="email" id="cliente-email"></div>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </form>
            </div>
        </div>

        <!-- Modal Proveedor -->
        <div id="modal-proveedor" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModal('modal-proveedor')">&times;</span>
                <h2 id="titulo-modal-proveedor">Añadir Proveedor</h2>
                <form id="form-proveedor" onsubmit="guardarProveedor(event)">
                    <input type="hidden" id="proveedor-id">
                    <div class="form-group"><label>Nombre</label><input type="text" id="proveedor-nombre" required></div>
                    <div class="form-group"><label>Teléfono</label><input type="tel" id="proveedor-telefono"></div>
                    <div class="form-group"><label>Email</label><input type="email" id="proveedor-email"></div>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </form>
            </div>
        </div>

        <!-- Modal Recepción de Mercancía -->
        <div id="modal-recepcion-mercancia" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModal('modal-recepcion-mercancia')">&times;</span>
                <h2>Recepción de Mercancía</h2>
                <form id="form-recepcion-mercancia" onsubmit="procesarRecepcionMercancia(event)">
                    <div class="form-group">
                        <label for="recepcion-proveedor">Proveedor</label>
                        <select id="recepcion-proveedor" required onchange="cargarProductosProveedor()">
                            <option value="">Seleccionar Proveedor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="recepcion-numero-factura">Número de Factura</label>
                        <input type="text" id="recepcion-numero-factura" required>
                    </div>
                    <div class="form-group">
                        <label for="recepcion-fecha">Fecha de Recepción</label>
                        <input type="date" id="recepcion-fecha" required>
                    </div>
                    <div class="form-group">
                        <label>Productos a Recibir</label>
                        <div id="productos-recepcion-lista" class="recepcion-product-list">
                            <!-- Lista de productos se renderizará aquí -->
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="recepcion-notas">Notas</label>
                        <textarea id="recepcion-notas" rows="3" placeholder="Notas adicionales sobre la recepción"></textarea>
                    </div>
                    <div id="recepcion-total-display" class="recepcion-total" style="text-align: left; margin-top: 20px;">
                        <p>Total Factura: <span id="simbolo-moneda-recepcion">$</span><span id="recepcion-total-monto">0.00</span></p>
                        <p style="font-size: 0.9em; color: #666;">Equivalente: Bs. <span id="recepcion-total-monto-bs">0.00</span></p>
                    </div>
                    <button type="submit" class="btn btn-success" style="margin-top: 15px;">Recibir Mercancía</button>
                </form>
            </div>
        </div>

        <!-- Modal Abono -->
        <div id="modal-abono" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModal('modal-abono')">&times;</span>
                <h2>Registrar Abono</h2>
                <p id="info-abono"></p>
                <form id="form-abono" onsubmit="guardarAbono(event)">
                    <div class="form-group"><label>Monto del Abono</label><input type="number" id="abono-monto" step="0.01" required></div>
                    <button type="submit" class="btn btn-success">Guardar Abono</button>
                </form>
            </div>
        </div>

        <!-- Modal Seleccionar Cliente -->
        <div id="modal-seleccion-cliente" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModalSeleccionCliente()">&times;</span>
                <h2>Seleccionar Cliente</h2>
                <div class="form-group">
                    <input type="text" id="buscar-cliente" placeholder="Buscar cliente por nombre...">
                </div>
                <div class="cliente-lista-container" id="lista-clientes-seleccion">
                    <!-- Clientes se renderizarán aquí -->
                </div>
            </div>
        </div>

        <!-- Modal Editar Factura -->
        <div id="modal-editar-factura" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModalEditarFactura()">&times;</span>
                <h2>Editar Factura</h2>
                <div id="info-factura-editar" style="margin-bottom: 20px;"></div>
                <form id="form-editar-factura" onsubmit="guardarCambiosFactura(event)">
                    <input type="hidden" id="editar-venta-id">
                    <table>
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad Original</th>
                                <th>Nueva Cantidad</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-productos-editar">
                            <!-- Productos se renderizarán aquí -->
                        </tbody>
                    </table>
                    <div style="margin-top: 20px; text-align: right;">
                        <button type="button" class="btn btn-secondary" onclick="cerrarModalEditarFactura()">Cancelar</button>
                        <button type="submit" class="btn btn-success">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal Movimientos de Inventario -->
        <div id="modal-movimientos-producto" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModalMovimientos()">&times;</span>
                <h2 id="titulo-movimientos">Movimientos de Inventario</h2>
                <table class="movimiento-tabla">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Cantidad</th>
                            <th>Referencia</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-movimientos-producto-especifico"></tbody>
                </table>
            </div>
        </div>

        <!-- Modal Calculadora -->
        <div id="modal-calculadora" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModal('modal-calculadora')">&times;</span>
                <h2>Calculadora</h2>
                <div class="calculator">
                    <div class="calc-display" id="calc-display">0</div>
                    <div class="calc-buttons">
                        <button class="calc-btn clear operator" data-key="Escape">AC</button>
                        <button class="calc-btn operator" data-key="/">÷</button>
                        <button class="calc-btn operator" data-key="*">×</button>
                        <button class="calc-btn operator" data-key="Backspace">←</button>
                        
                        <button class="calc-btn" data-key="7">7</button>
                        <button class="calc-btn" data-key="8">8</button>
                        <button class="calc-btn" data-key="9">9</button>
                        <button class="calc-btn operator" data-key="-">−</button>
                        
                        <button class="calc-btn" data-key="4">4</button>
                        <button class="calc-btn" data-key="5">5</button>
                        <button class="calc-btn" data-key="6">6</button>
                        <button class="calc-btn operator" data-key="+">+</button>
                        
                        <button class="calc-btn" data-key="1">1</button>
                        <button class="calc-btn" data-key="2">2</button>
                        <button class="calc-btn" data-key="3">3</button>
                        <button class="calc-btn equals" style="grid-row: span 2;" data-key="Enter">=</button>

                        <button class="calc-btn zero" data-key="0">0</button>
                        <button class="calc-btn" data-key=".">.</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Pago Mixto -->
        <div id="modal-pago" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModal('modal-pago')">&times;</span>
                <h2>Procesar Pago</h2>
                
                <div class="payment-summary">
                    <p class="payment-summary-total" id="pago-total-usd">$0.00</p>
                    <p class="payment-summary-secondary" id="pago-total-bs">Bs. 0.00</p>
                </div>
                
                <div class="payment-input-group">
                    <input type="number" id="pago-monto-input" class="payment-input" placeholder="Monto a pagar">
                    <select id="pago-moneda-select" class="payment-currency-select">
                        <option value="dolares">Dólares ($)</option>
                        <option value="bolivares">Bolívares (Bs.)</option>
                    </select>
                    <button class="btn btn-primary" onclick="agregarPago()">Agregar</button>
                </div>
                
                <ul id="lista-pagos" class="payments-list"></ul>
                
                <div class="payment-balance-grid">
                    <div class="payment-balance-card paid-card">
                        <p class="payment-balance-card-title">Total Pagado</p>
                        <p class="payment-balance-card-amount" id="pago-total-pagado">$0.00</p>
                    </div>
                    <div class="payment-balance-card" id="pago-balance-card">
                        <p class="payment-balance-card-title" id="pago-balance-titulo">Faltante</p>
                        <p class="payment-balance-card-amount" id="pago-balance-monto">$0.00</p>
                        <p class="payment-balance-card-secondary" id="pago-balance-monto-bs">Bs. 0.00</p>
                    </div>
                </div>

                <button id="btn-finalizar-venta" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 18px;" onclick="finalizarVentaContado()" disabled>Finalizar Venta</button>
            </div>
        </div>

        <!-- Modal Recuperación de Contraseña -->
        <div id="modal-recuperar-password" class="modal">
            <div class="modal-content">
                <span class="close" onclick="cerrarModal('modal-recuperar-password')">&times;</span>
                <h2>Recuperar Contraseña</h2>
                
                <div class="recovery-steps">
                    <div id="paso1">
                        <h3><span class="step-indicator active">1</span>Identificar tu cuenta</h3>
                        <form onsubmit="verificarEmailRecuperacion(event)">
                            <div class="form-group">
                                <label for="recovery-email">Correo Electrónico</label>
                                <input type="email" id="recovery-email" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Verificar</button>
                        </form>
                    </div>
                    
                    <div id="paso2" style="display: none;">
                        <h3><span class="step-indicator">2</span>Responder pregunta de seguridad</h3>
                        <div class="security-question" id="security-question-display"></div>
                        <form onsubmit="verificarRespuestaSeguridad(event)">
                            <div class="form-group">
                                <label for="recovery-answer">Tu respuesta</label>
                                <input type="text" id="recovery-answer" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Verificar</button>
                        </form>
                    </div>
                    
                    <div id="paso3" style="display: none;">
                        <h3><span class="step-indicator">3</span>Establecer nueva contraseña</h3>
                        <form onsubmit="restablecerPassword(event)">
                            <div class="form-group">
                                <label for="new-password">Nueva Contraseña</label>
                                <input type="password" id="new-password" required>
                            </div>
                            <div class="form-group">
                                <label for="confirm-new-password">Confirmar Contraseña</label>
                                <input type="password" id="confirm-new-password" required>
                            </div>
                            <button type="submit" class="btn btn-success">Restablecer Contraseña</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- GESTIÓN DE DATOS (localStorage) ---
    const CLAVES_STORAGE = { 
        productos: 'pos_productos', 
        clientes: 'pos_clientes', 
        proveedores: 'pos_proveedores', 
        ventas: 'pos_ventas', 
        cuentasPorCobrar: 'pos_cxc', 
        ventasCobradas: 'pos_ventas_cobradas', 
        ultimoNumeroFactura: 'pos_ultimo_num_factura', 
        movimientosInventario: 'pos_movimientos_inventario',
        usuarios: 'pos_usuarios',
        usuarioLogueado: 'pos_usuario_logueado',
        recepcionesMercancia: 'pos_recepciones_mercancia',
        planes: 'pos_planes'
    };
    const datos = { 
        productos: [], 
        clientes: [], 
        proveedores: [], 
        ventas: [], 
        cuentasPorCobrar: [], 
        ventasCobradas: [], 
        movimientosInventario: [],
        usuarios: [],
        recepcionesMercancia: [],
        planes: []
    };
    let imagenBase64 = null;
    let selectedClientId = null;
    let selectedClientName = '';
    let simboloMoneda = '$';
    let negocioActualId = null;
    let recuperacionUsuarioActual = null;
    let tasaCambio = 36.50;
    let pagosTemporales = [];

    // --- CONFIGURACIÓN DE ROLES Y PERMISOS ---
    const ROLES = {
        PATRON: 'patron',
        SUPERVISOR: 'supervisor',
        INVENTARIO: 'inventario',
        CAJERO: 'cajero'
    };

    const PERMISOS = {
        [ROLES.PATRON]: ['pos', 'inventario', 'clientes', 'proveedores', 'cxc', 'ventas-cobradas', 'informes', 'movimientos', 'planes'],
        [ROLES.SUPERVISOR]: ['pos', 'inventario', 'clientes', 'proveedores', 'informes', 'movimientos', 'planes'],
        [ROLES.INVENTARIO]: ['inventario', 'proveedores', 'movimientos'],
        [ROLES.CAJERO]: ['pos', 'clientes']
    };

    // Preguntas de seguridad para recuperación
    const PREGUNTAS_SEGURIDAD = {
        pet: '¿Cuál es el nombre de tu primera mascota?',
        school: '¿Cuál es el nombre de tu escuela primaria?',
        city: '¿En qué ciudad naciste?',
        friend: '¿Cuál es el nombre de tu mejor amigo de la infancia?',
        movie: '¿Cuál es tu película favorita?'
    };

    function cargarDatos() {
        for (let key in datos) {
            const guardado = localStorage.getItem(CLAVES_STORAGE[key]);
            if (guardado) { 
                datos[key] = JSON.parse(guardado); 
            }
        }
        
        const usuario = JSON.parse(localStorage.getItem(CLAVES_STORAGE.usuarioLogueado) || null);
        if (usuario) {
            const patron = datos.usuarios.find(u => u.id === (usuario.rol === ROLES.PATRON ? usuario.id : usuario.patronId));
            if (patron && patron.tasaCambio) {
                actualizarTasaDeCambioEnUI(patron.tasaCambio);
            }
        }
    }

    function guardarDatos(clave) {
        localStorage.setItem(CLAVES_STORAGE[clave], JSON.stringify(datos[clave]));
    }

    function getSimboloMoneda() {
        const usuario = JSON.parse(localStorage.getItem(CLAVES_STORAGE.usuarioLogueado) || '{}');
        return usuario.moneda || '$';
    }

    function actualizarSimboloMonedaEnUI() {
        simboloMoneda = getSimboloMoneda();
        document.getElementById('simbolo-moneda-total').textContent = simboloMoneda;
        // Recargar vistas para reflejar el símbolo de moneda
        const activeView = document.querySelector('.view.active');
        if (activeView) {
            const viewId = activeView.id;
            if (viewId === 'vista-inventario') renderizarInventario();
            if (viewId === 'vista-cxc') renderizarCxC();
            if (viewId === 'vista-ventas-cobradas') renderizarVentasCobradas();
            if (viewId === 'vista-informes') renderizarInformes();
            if (viewId === 'vista-planes') renderizarModuloPlanes();
        }
        renderizarProductosPOS();
        renderizarCarrito();
    }
    
    // --- FUNCIÓN CENTRALIZADA PARA ACTUALIZAR TASA DE CAMBIO ---
    function actualizarTasaDeCambioEnUI(nuevaTasa) {
        tasaCambio = parseFloat(nuevaTasa);
        document.documentElement.style.setProperty('--bs-rate', tasaCambio);
        
        // Actualizar todos los displays de tasa de cambio
        document.querySelectorAll('#tasa-cambio-display, #tasa-cambio-actual').forEach(el => {
            el.textContent = tasaCambio.toFixed(2);
        });
        document.getElementById('nueva-tasa-cambio').value = tasaCambio.toFixed(2);
        document.getElementById('equivalente-100').textContent = (tasaCambio * 100).toFixed(2);
        
        // Recalcular y re-renderizar componentes afectados
        renderizarCarrito();
        // Si el modal de pago está abierto, actualizarlo también
        if (document.getElementById('modal-pago').style.display === 'block') {
            actualizarModalPago();
        }
    }

    // --- FUNCIONES GLOBALES ---
    function generarId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
    
    function getSiguienteNumeroFactura() {
        let ultimoNumero = parseInt(localStorage.getItem(CLAVES_STORAGE.ultimoNumeroFactura) || '0');
        ultimoNumero++;
        localStorage.setItem(CLAVES_STORAGE.ultimoNumeroFactura, ultimoNumero.toString());
        return ultimoNumero;
    }

    function findVentaById(ventaId) {
        return datos.ventas.find(v => v.id === ventaId);
    }

    // --- REGISTRO DE MOVIMIENTOS MEJORADO ---
    function registrarMovimiento(productoId, productoNombre, cantidad, tipo, referencia, usuarioId = null) {
        const usuarioLogueado = JSON.parse(localStorage.getItem(CLAVES_STORAGE.usuarioLogueado) || '{}');
        const movimiento = {
            id: generarId(),
            productoId,
            productoNombre,
            cantidad,
            tipo,
            referencia,
            usuarioId: usuarioId || usuarioLogueado.id,
            fecha: new Date().toISOString(),
            patronId: negocioActualId
        };
        datos.movimientosInventario.push(movimiento);
        guardarDatos('movimientosInventario');
    }

    // --- SISTEMA DE NOTIFICACIONES MEJORADO ---
    function mostrarNotificacion(mensaje, tipo = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${tipo}`;
        notification.textContent = mensaje;
        document.body.appendChild(notification);

        // Forzar reflow para activar la transición
        notification.offsetHeight; 
        notification.classList.add('show');

        setTimeout(() => {
            notification.classList.remove('show');
            // Esperar a que la transición termine para remover el elemento
            notification.addEventListener('transitionend', () => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            });
        }, 3000);
    }

    // --- FUNCIÓN DEBOUNCE PARA BÚSQUEDA EFICIENTE ---
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }

    // --- VALIDACIÓN DE DATOS ROBUSTA ---
    function validarProducto(producto) {
        if (!producto.nombre || producto.nombre.trim() === '') {
            mostrarNotificacion('El nombre del producto es obligatorio.', 'error');
            return false;
        }
        if (producto.costoCompra < 0) {
            mostrarNotificacion('El costo de compra no puede ser negativo.', 'error');
            return false;
        }
        if (producto.precioVenta <= 0) {
            mostrarNotificacion('El precio de venta debe ser mayor a cero.', 'error');
            return false;
        }
        if (producto.stock < 0) {
            mostrarNotificacion('El stock no puede ser negativo.', 'error');
            return false;
        }
        return true;
    }

    function validarCliente(cliente) {
        if (!cliente.nombre || cliente.nombre.trim() === '') {
            mostrarNotificacion('El nombre del cliente es obligatorio.', 'error');
            return false;
        }
        if (cliente.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(cliente.email)) {
            mostrarNotificacion('El formato del correo electrónico no es válido.', 'error');
            return false;
        }
        return true;
    }

    function validarProveedor(proveedor) {
        if (!proveedor.nombre || proveedor.nombre.trim() === '') {
            mostrarNotificacion('El nombre del proveedor es obligatorio.', 'error');
            return false;
        }
        if (proveedor.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(proveedor.email)) {
            mostrarNotificacion('El formato del correo electrónico no es válido.', 'error');
            return false;
        }
        return true;
    }

    // --- OPTIMIZACIÓN DE IMÁGENES ---
    function procesarImagen(file) {
        return new Promise((resolve, reject) => {
            if (!file) {
                resolve(null);
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 800;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const quality = 0.7;
                    const dataURL = canvas.toDataURL('image/jpeg', quality);
                    resolve(dataURL);
                };
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    // --- LÓGICA DE CÓDIGO DE BARRAS ---
    function buscarPorBarcode() {
        const barcode = document.getElementById('barcode-input').value.trim();
        if (!barcode) {
            mostrarNotificacion('Por favor ingrese un código de barras.', 'error');
            return;
        }

        const productosNegocio = datos.productos.filter(p => p.patronId === negocioActualId);
        const producto = productosNegocio.find(p => p.barcode === barcode);

        if (producto) {
            if (producto.stock > 0) {
                añadirAlCarrito(producto);
                document.getElementById('barcode-input').value = '';
                mostrarNotificacion(`Producto "${producto.nombre}" agregado al carrito.`, 'success');
            } else {
                mostrarNotificacion(`El producto "${producto.nombre}" no tiene stock disponible.`, 'error');
            }
        } else {
            mostrarNotificacion('No se encontró ningún producto con ese código de barras.', 'error');
        }
    }

    function procesarBarcodeInput(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            buscarPorBarcode();
        }
    }

    // --- LÓGICA DE RECUPERACIÓN DE CONTRASEÑA ---
    function abrirModalRecuperarPassword() {
        document.getElementById('modal-recuperar-password').style.display = 'block';
        resetearFormularioRecuperacion();
    }

    function resetearFormularioRecuperacion() {
        document.getElementById('paso1').style.display = 'block';
        document.getElementById('paso2').style.display = 'none';
        document.getElementById('paso3').style.display = 'none';
        document.getElementById('recovery-email').value = '';
        document.getElementById('recovery-answer').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-new-password').value = '';
        recuperacionUsuarioActual = null;
        
        document.querySelectorAll('.step-indicator').forEach(indicator => {
            indicator.classList.remove('active', 'completed');
        });
        document.querySelector('#paso1 .step-indicator').classList.add('active');
    }

    function verificarEmailRecuperacion(event) {
        event.preventDefault();
        const email = document.getElementById('recovery-email').value;
        const usuario = datos.usuarios.find(u => u.email === email);

        if (!usuario) {
            mostrarNotificacion('No existe una cuenta con ese correo electrónico.', 'error');
            return;
        }

        if (!usuario.preguntaSeguridad || !usuario.respuestaSeguridad) {
            mostrarNotificacion('Esta cuenta no tiene configurada la recuperación de contraseña. Contacte al administrador.', 'error');
            return;
        }

        recuperacionUsuarioActual = usuario;
        
        document.getElementById('paso1').style.display = 'none';
        document.getElementById('paso2').style.display = 'block';
        document.getElementById('security-question-display').textContent = PREGUNTAS_SEGURIDAD[usuario.preguntaSeguridad];
        
        document.querySelector('#paso1 .step-indicator').classList.remove('active');
        document.querySelector('#paso1 .step-indicator').classList.add('completed');
        document.querySelector('#paso2 .step-indicator').classList.add('active');
    }

    function verificarRespuestaSeguridad(event) {
        event.preventDefault();
        const respuesta = document.getElementById('recovery-answer').value.toLowerCase().trim();
        const respuestaCorrecta = recuperacionUsuarioActual.respuestaSeguridad.toLowerCase().trim();

        if (respuesta !== respuestaCorrecta) {
            mostrarNotificacion('Respuesta incorrecta. Intenta nuevamente.', 'error');
            return;
        }

        document.getElementById('paso2').style.display = 'none';
        document.getElementById('paso3').style.display = 'block';
        
        document.querySelector('#paso2 .step-indicator').classList.remove('active');
        document.querySelector('#paso2 .step-indicator').classList.add('completed');
        document.querySelector('#paso3 .step-indicator').classList.add('active');
    }

    function restablecerPassword(event) {
        event.preventDefault();
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-new-password').value;

        if (newPassword !== confirmPassword) {
            mostrarNotificacion('Las contraseñas no coinciden.', 'error');
            return;
        }

        if (newPassword.length < 6) {
            mostrarNotificacion('La contraseña debe tener al menos 6 caracteres.', 'error');
            return;
        }

        const index = datos.usuarios.findIndex(u => u.id === recuperacionUsuarioActual.id);
        if (index !== -1) {
            datos.usuarios[index].password = btoa(newPassword);
            guardarDatos('usuarios');
            
            mostrarNotificacion('Contraseña restablecida con éxito. Ahora puedes iniciar sesión.', 'success');
            cerrarModal('modal-recuperar-password');
            mostrarLogin();
        }
    }

    // --- LÓGICA DE AUTENTICACIÓN Y ROLES ---
    function mostrarLogin() {
        document.getElementById('login-box').style.display = 'block';
        document.getElementById('register-box').style.display = 'none';
    }

    function mostrarRegistro() {
        document.getElementById('login-box').style.display = 'none';
        document.getElementById('register-box').style.display = 'block';
    }

    function mostrarMensajeAuth(contenedorId, texto, tipo) {
        const container = document.getElementById(contenedorId);
        const message = document.createElement('div');
        message.className = `message ${tipo}`;
        message.textContent = texto;
        container.innerHTML = '';
        container.appendChild(message);
        setTimeout(() => { container.innerHTML = ''; }, 4000);
    }

    function registrarUsuario(event) {
        event.preventDefault();
        const nombre = document.getElementById('register-name').value;
        const nombreNegocio = document.getElementById('register-business-name').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const passwordConfirm = document.getElementById('register-password-confirm').value;
        const preguntaSeguridad = document.getElementById('register-security-question').value;
        const respuestaSeguridad = document.getElementById('register-security-answer').value;

        if (password !== passwordConfirm) {
            mostrarMensajeAuth('register-message-container', 'Las contraseñas no coinciden.', 'error');
            return;
        }

        if (datos.usuarios.find(u => u.email === email)) {
            mostrarMensajeAuth('register-message-container', 'El correo electrónico ya está en uso.', 'error');
            return;
        }
        
        const nuevoUsuario = {
            id: generarId(),
            nombre: nombre,
            nombreNegocio: nombreNegocio,
            email: email,
            password: btoa(password),
            preguntaSeguridad: preguntaSeguridad,
            respuestaSeguridad: respuestaSeguridad,
            moneda: '$',
            rol: ROLES.PATRON,
            colores: {
                primary: '#2c3e50',
                sidebar: '#2c3e50',
                secondary: '#3498db',
                success: '#27ae60',
                danger: '#e74c3c',
                warning: '#f39c12'
            },
            tasaCambio: 36.50
        };

        datos.usuarios.push(nuevoUsuario);
        guardarDatos('usuarios');
        
        mostrarMensajeAuth('register-message-container', '¡Negocio registrado con éxito! Redirigiendo...', 'success');
        
        setTimeout(() => {
            iniciarSesionAutomaticamente(nuevoUsuario);
        }, 1500);
    }

    function iniciarSesionAutomaticamente(usuario) {
        localStorage.setItem(CLAVES_STORAGE.usuarioLogueado, JSON.stringify(usuario));
        negocioActualId = usuario.id;
        mostrarAppPrincipal();
    }

    function iniciarSesion(event) {
        event.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        const usuario = datos.usuarios.find(u => u.email === email);

        if (!usuario || (usuario.rol === ROLES.PATRON && usuario.password !== btoa(password)) || 
            (usuario.rol !== ROLES.PATRON && usuario.claveAcceso !== btoa(password))) {
            mostrarMensajeAuth('login-message-container', 'Correo o contraseña incorrectos.', 'error');
            return;
        }

        localStorage.setItem(CLAVES_STORAGE.usuarioLogueado, JSON.stringify(usuario));
        negocioActualId = usuario.rol === ROLES.PATRON ? usuario.id : usuario.patronId;
        mostrarAppPrincipal();
    }
    
    function abrirModalPatronLogin() {
        document.getElementById('modal-patron-login').style.display = 'block';
    }

    function ingresarComoPatron(event) {
        event.preventDefault();
        const email = document.getElementById('patron-login-email').value;
        const password = document.getElementById('patron-login-password').value;

        const patron = datos.usuarios.find(u => u.email === email && u.rol === ROLES.PATRON);

        if (!patron || patron.password !== btoa(password)) {
            mostrarNotificacion('Correo o contraseña de patrón incorrectos.', 'error');
            return;
        }

        localStorage.setItem(CLAVES_STORAGE.usuarioLogueado, JSON.stringify(patron));
        negocioActualId = patron.id;
        cerrarModal('modal-patron-login');
        location.reload();
    }
    
    function abrirModalCambiarUsuario() {
        renderizarListaNegocios();
        document.getElementById('modal-cambiar-usuario').style.display = 'block';
    }

    function renderizarListaNegocios() {
        const lista = document.getElementById('lista-negocios');
        lista.innerHTML = '';
        
        const patronActual = datos.usuarios.find(u => u.id === negocioActualId);

        if (!patronActual) {
            lista.innerHTML = '<p>Error: No se pudo encontrar el negocio actual.</p>';
            return;
        }
        
        const item = document.createElement('div');
        item.className = 'negocio-item selected';
        item.innerHTML = `<strong>${patronActual.nombreNegocio}</strong><br><small>${patronActual.nombre}</small>`;
        lista.appendChild(item);
    }

    function seleccionarNegocio(negocioId) {
        negocioActualId = negocioId;
        document.querySelectorAll('.negocio-item').forEach(item => item.classList.remove('selected'));
        event.target.closest('.negocio-item').classList.add('selected');
    }

    function iniciarSesionDesdeModal(event) {
        event.preventDefault();
        const email = document.getElementById('modal-login-email').value;
        const password = document.getElementById('modal-login-password').value;

        const usuario = datos.usuarios.find(u => u.email === email);

        if (!usuario) {
            mostrarNotificacion('Usuario no encontrado.', 'error');
            return;
        }

        if (usuario.rol === ROLES.PATRON && usuario.id !== negocioActualId) {
            mostrarNotificacion('Este usuario no pertenece a este negocio.', 'error');
            return;
        }
        
        if (usuario.rol !== ROLES.PATRON && usuario.patronId !== negocioActualId) {
            mostrarNotificacion('Este usuario no pertenece a este negocio.', 'error');
            return;
        }

        if ((usuario.rol === ROLES.PATRON && usuario.password !== btoa(password)) || 
            (usuario.rol !== ROLES.PATRON && usuario.claveAcceso !== btoa(password))) {
            mostrarNotificacion('Contraseña o clave incorrecta.', 'error');
            return;
        }

        localStorage.setItem(CLAVES_STORAGE.usuarioLogueado, JSON.stringify(usuario));
        cerrarModal('modal-cambiar-usuario');
        location.reload();
    }

    function cerrarSesion() {
        if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
            localStorage.removeItem(CLAVES_STORAGE.usuarioLogueado);
            negocioActualId = null;
            location.reload();
        }
    }

    function verificarSesion() {
        const usuarioLogueadoData = localStorage.getItem(CLAVES_STORAGE.usuarioLogueado);
        if (usuarioLogueadoData) {
            const usuario = JSON.parse(usuarioLogueadoData);
            const userExists = datos.usuarios.find(u => u.id === usuario.id);
            if(userExists) {
                negocioActualId = usuario.rol === ROLES.PATRON ? usuario.id : usuario.patronId;
                mostrarAppPrincipal(usuario);
            } else {
                localStorage.removeItem(CLAVES_STORAGE.usuarioLogueado);
                negocioActualId = null;
                document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('main-app-container').style.display = 'none';
            }
        } else {
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('main-app-container').style.display = 'none';
        }
    }

    function renderizarNavegacion() {
        const nav = document.getElementById('main-nav');
        nav.innerHTML = '';

        const buttons = [
            { id: 'vista-pos', text: 'Punto de Venta', permiso: 'pos' },
            { id: 'vista-inventario', text: 'Inventario', permiso: 'inventario' },
            { id: 'vista-clientes', text: 'Clientes', permiso: 'clientes' },
            { id: 'vista-proveedores', text: 'Proveedores', permiso: 'proveedores' },
            { id: 'vista-movimientos', text: 'Movimientos', permiso: 'movimientos' },
            { id: 'vista-cxc', text: 'Cuentas por Cobrar', permiso: 'cxc' },
            { id: 'vista-ventas-cobradas', text: 'Ventas Cobradas', permiso: 'ventas-cobradas' },
            { id: 'vista-informes', text: 'Informes', permiso: 'informes' },
            { id: 'vista-planes', text: 'Planes de Ahorro', permiso: 'planes'}
        ];

        const permisosUsuario = PERMISOS[window.rolUsuarioLogueado] || [];

        buttons.forEach(btn => {
            if (permisosUsuario.includes(btn.permiso)) {
                const button = document.createElement('button');
                button.className = 'nav-button';
                if (btn.id === 'vista-pos') button.classList.add('active');
                button.textContent = btn.text;
                button.onclick = (e) => mostrarVista(btn.id, e.currentTarget);
                nav.appendChild(button);
            }
        });
        
        const calcButtonContainer = document.createElement('div');
        calcButtonContainer.style.marginLeft = 'auto'; // Push to the end in flex row layout
        calcButtonContainer.style.alignSelf = 'flex-start'; // Align top in flex column layout
        const calcButton = document.createElement('button');
        calcButton.className = 'nav-button';
        calcButton.innerHTML = '<svg viewBox="0 0 24 24" fill="white" width="24" height="24"><path d="M7,2H17A2,2 0 0,1 19,4V20A2,2 0 0,1 17,22H7A2,2 0 0,1 5,20V4A2,2 0 0,1 7,2M7,6V8H17V6H7M7,10V12H17V10H7M7,14V16H17V14H7M10,18H14V20H10V18Z" /></svg>';
        calcButton.title = 'Calculadora';
        calcButton.addEventListener('click', abrirModalCalculadora);
        calcButtonContainer.appendChild(calcButton);
        nav.appendChild(calcButtonContainer);
    }

    function mostrarAppPrincipal(usuario = null) {
        const usuarioLogueado = usuario || JSON.parse(localStorage.getItem(CLAVES_STORAGE.usuarioLogueado));
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('main-app-container').style.display = 'grid';
        document.getElementById('usuario-logueado-nombre').textContent = usuarioLogueado.nombre;
        document.getElementById('usuario-logueado-rol').textContent = usuarioLogueado.rol.charAt(0).toUpperCase() + usuarioLogueado.rol.slice(1);
        
        const patron = datos.usuarios.find(u => u.id === negocioActualId);
        document.getElementById('header-business-name').textContent = patron ? patron.nombreNegocio : 'Mi Negocio';
        
        window.rolUsuarioLogueado = usuarioLogueado.rol;

        if (patron && patron.tasaCambio) {
            actualizarTasaDeCambioEnUI(patron.tasaCambio);
        }

        const switchUserBtn = document.getElementById('btn-cambiar-usuario');
        const settingsBtn = document.getElementById('btn-configuracion');
        const patronLoginBtn = document.getElementById('btn-patron-login');

        if (window.rolUsuarioLogueado === ROLES.PATRON) {
            switchUserBtn.style.display = 'block';
            settingsBtn.style.display = 'block';
            patronLoginBtn.style.display = 'none';
        } else {
            switchUserBtn.style.display = 'none';
            settingsBtn.style.display = 'none';
            patronLoginBtn.style.display = 'block';
        }

        if (usuarioLogueado.colores) {
            aplicarColores(usuarioLogueado.colores);
        }
        
        renderizarNavegacion();
        actualizarSimboloMonedaEnUI();
        mostrarVista('vista-pos', document.querySelector('#main-nav .nav-button'));
    }

    // --- LÓGICA DE CONFIGURACIÓN ---
    function abrirModalConfiguracion() {
        const usuario = JSON.parse(localStorage.getItem(CLAVES_STORAGE.usuarioLogueado));
        document.getElementById('config-nombre').value = usuario.nombre;
        document.getElementById('config-email').value = usuario.email;
        
        const patron = datos.usuarios.find(u => u.id === negocioActualId);
        document.getElementById('config-nombre-negocio').value = patron ? patron.nombreNegocio : '';
        document.getElementById('config-moneda').value = patron ? patron.moneda : '$';
        document.getElementById('config-tasa-cambio').value = patron ? patron.tasaCambio : 36.50;
        
        const colores = usuario.colores || {
            primary: '#2c3e50',
            sidebar: '#2c3e50',
            secondary: '#3498db',
            success: '#27ae60',
            danger: '#e74c3c',
            warning: '#f39c12'
        };
        
        document.getElementById('config-color-primary').value = colores.primary;
        document.getElementById('config-color-primary-text').value = colores.primary;
        document.getElementById('config-color-sidebar').value = colores.sidebar;
        document.getElementById('config-color-sidebar-text').value = colores.sidebar;
        document.getElementById('config-color-secondary').value = colores.secondary;
        document.getElementById('config-color-secondary-text').value = colores.secondary;
        document.getElementById('config-color-success').value = colores.success;
        document.getElementById('config-color-success-text').value = colores.success;
        document.getElementById('config-color-danger').value = colores.danger;
        document.getElementById('config-color-danger-text').value = colores.danger;
        document.getElementById('config-color-warning').value = colores.warning;
        document.getElementById('config-color-warning-text').value = colores.warning;
        
        renderizarUsuarios();
        renderizarTemasPredefinidos();
        document.getElementById('modal-configuracion').style.display = 'block';
    }

    function mostrarTabConfig(tabName) {
        document.querySelectorAll('.config-tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.config-tab-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`config-${tabName}`).classList.add('active');
        event.target.classList.add('active');
    }

    function guardarConfiguracionPerfil(event) {
        event.preventDefault();
        const usuario = JSON.parse(localStorage.getItem(CLAVES_STORAGE.usuarioLogueado));
        usuario.nombre = document.getElementById('config-nombre').value;
        usuario.email = document.getElementById('config-email').value;
        
        const index = datos.usuarios.findIndex(u => u.id === usuario.id);
        if(index !== -1) {
            datos.usuarios[index] = usuario;
            guardarDatos('usuarios');
        }
        
        localStorage.setItem(CLAVES_STORAGE.usuarioLogueado, JSON.stringify(usuario));
        document.getElementById('usuario-logueado-nombre').textContent = usuario.nombre;
        cerrarModal('modal-configuracion');
        mostrarNotificacion('Perfil actualizado con éxito.', 'success');
    }

    function guardarConfiguracionNegocio(event) {
        event.preventDefault();
        const patron = datos.usuarios.find(u => u.id === negocioActualId);
        if (patron) {
            patron.nombreNegocio = document.getElementById('config-nombre-negocio').value;
            patron.moneda = document.getElementById('config-moneda').value;
            const nuevaTasa = parseFloat(document.getElementById('config-tasa-cambio').value);
            patron.tasaCambio = nuevaTasa;
            
            const index = datos.usuarios.findIndex(u => u.id === patron.id);
            if(index !== -1) {
                datos.usuarios[index] = patron;
                guardarDatos('usuarios');
            }
            
            actualizarTasaDeCambioEnUI(nuevaTasa);
            
            document.getElementById('header-business-name').textContent = patron.nombreNegocio;
            cerrarModal('modal-configuracion');
            mostrarNotificacion('Configuración del negocio actualizada.', 'success');
            actualizarSimboloMonedaEnUI();
        }
    }
    
    function guardarConfiguracionApariencia(event) {
        event.preventDefault();
        const usuario = JSON.parse(localStorage.getItem(CLAVES_STORAGE.usuarioLogueado));
        
        const colores = {
            primary: document.getElementById('config-color-primary').value,
            sidebar: document.getElementById('config-color-sidebar').value,
            secondary: document.getElementById('config-color-secondary').value,
            success: document.getElementById('config-color-success').value,
            danger: document.getElementById('config-color-danger').value,
            warning: document.getElementById('config-color-warning').value
        };
        
        usuario.colores = colores;
        
        const index = datos.usuarios.findIndex(u => u.id === usuario.id);
        if(index !== -1) {
            datos.usuarios[index] = usuario;
            guardarDatos('usuarios');
        }

        localStorage.setItem(CLAVES_STORAGE.usuarioLogueado, JSON.stringify(usuario));
        aplicarColores(colores);
        cerrarModal('modal-configuracion');
        mostrarNotificacion('Colores de la aplicación actualizados.', 'success');
    }
    
    function aplicarColores(colores) {
        const root = document.documentElement;
        root.style.setProperty('--primary-color', colores.primary);
        root.style.setProperty('--sidebar-color', colores.sidebar || colores.primary);
        root.style.setProperty('--secondary-color', colores.secondary);
        root.style.setProperty('--success-color', colores.success);
        root.style.setProperty('--danger-color', colores.danger);
        root.style.setProperty('--warning-color', colores.warning);
    }
    
    function restablecerColoresPorDefecto() {
        const coloresPorDefecto = {
            primary: '#2c3e50',
            sidebar: '#2c3e50',
            secondary: '#3498db',
            success: '#27ae60',
            danger: '#e74c3c',
            warning: '#f39c12'
        };
        
        document.getElementById('config-color-primary').value = coloresPorDefecto.primary;
        document.getElementById('config-color-primary-text').value = coloresPorDefecto.primary;
        document.getElementById('config-color-sidebar').value = coloresPorDefecto.sidebar;
        document.getElementById('config-color-sidebar-text').value = coloresPorDefecto.sidebar;
        document.getElementById('config-color-secondary').value = coloresPorDefecto.secondary;
        document.getElementById('config-color-secondary-text').value = coloresPorDefecto.secondary;
        document.getElementById('config-color-success').value = coloresPorDefecto.success;
        document.getElementById('config-color-success-text').value = coloresPorDefecto.success;
        document.getElementById('config-color-danger').value = coloresPorDefecto.danger;
        document.getElementById('config-color-danger-text').value = coloresPorDefecto.danger;
        document.getElementById('config-color-warning').value = coloresPorDefecto.warning;
        document.getElementById('config-color-warning-text').value = coloresPorDefecto.warning;
    }

    const predefinedThemes = {
        'Océano Profundo': { primary: '#2c3e50', sidebar: '#2c3e50', secondary: '#3498db', success: '#27ae60', danger: '#e74c3c', warning: '#f39c12' },
        'Bosque Esmeralda': { primary: '#2d5a3d', sidebar: '#2d5a3d', secondary: '#5e8c61', success: '#73b06f', danger: '#c0392b', warning: '#f1c40f' },
        'Atardecer Radiante': { primary: '#e67e22', sidebar: '#d35400', secondary: '#d35400', success: '#27ae60', danger: '#c0392b', warning: '#f39c12' },
        'Púrpura Real': { primary: '#4a148c', sidebar: '#4a148c', secondary: '#8e24aa', success: '#4caf50', danger: '#f44336', warning: '#ff9800' },
        'Monocromático': { primary: '#34495e', sidebar: '#2c3e50', secondary: '#7f8c8d', success: '#95a5a6', danger: '#bdc3c7', warning: '#ecf0f1' },
    };

    function renderizarTemasPredefinidos() {
        const container = document.getElementById('predefined-themes-container');
        container.innerHTML = '';
        for (const themeName in predefinedThemes) {
            const theme = predefinedThemes[themeName];
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'theme-button';
            button.onclick = () => seleccionarTema(themeName);
            
            let swatchesHtml = '<div class="theme-preview">';
            for(const color in theme) {
                swatchesHtml += `<div class="theme-color-swatch" style="background-color: ${theme[color]}"></div>`;
            }
            swatchesHtml += '</div>';

            button.innerHTML = `<span>${themeName}</span>${swatchesHtml}`;
            container.appendChild(button);
        }
    }

    function seleccionarTema(themeName) {
        const theme = predefinedThemes[themeName];
        if (!theme) return;
        
        // Update color picker values
        document.getElementById('config-color-primary').value = theme.primary;
        document.getElementById('config-color-sidebar').value = theme.sidebar;
        document.getElementById('config-color-secondary').value = theme.secondary;
        document.getElementById('config-color-success').value = theme.success;
        document.getElementById('config-color-danger').value = theme.danger;
        document.getElementById('config-color-warning').value = theme.warning;
        
        // Trigger input events to update the text fields
        document.querySelectorAll('#config-apariencia input[type="color"]').forEach(input => {
            input.dispatchEvent(new Event('input', { bubbles: true }));
        });

        // Apply and save automatically by submitting the form
        const form = document.querySelector('#config-apariencia form');
        if (form.requestSubmit) {
            form.requestSubmit();
        } else {
            // Fallback for older browsers
            form.dispatchEvent(new Event('submit', {cancelable: true, bubbles: true}));
        }
        mostrarNotificacion(`Tema "${themeName}" aplicado.`, 'info');
    }
    
    // --- LÓGICA DE USUARIOS ---
    function abrirModalUsuario(usuarioId = null) {
        document.getElementById('titulo-modal-usuario').textContent = usuarioId ? 'Editar Usuario' : 'Añadir Usuario';
        const form = document.getElementById('form-usuario'); form.reset();
        document.getElementById('usuario-id').value = '';
        if (usuarioId) {
            const usuario = datos.usuarios.find(u => u.id === usuarioId);
            document.getElementById('usuario-id').value = usuario.id;
            document.getElementById('usuario-nombre').value = usuario.nombre;
            document.getElementById('usuario-email').value = usuario.email;
            document.getElementById('usuario-rol').value = usuario.rol;
        }
        actualizarCampoClave();
        document.getElementById('modal-usuario').style.display = 'block';
    }

    function actualizarCampoClave() {
        const rol = document.getElementById('usuario-rol').value;
        const grupoClave = document.getElementById('grupo-clave');
        const campoClave = document.getElementById('usuario-clave');
        
        if (rol === ROLES.PATRON) {
            grupoClave.style.display = 'none';
            campoClave.removeAttribute('required');
        } else {
            grupoClave.style.display = 'block';
            campoClave.setAttribute('required', 'required');
        }
    }

    function guardarUsuario(event) {
        event.preventDefault();
        const id = document.getElementById('usuario-id').value || generarId();
        const rol = document.getElementById('usuario-rol').value;
        const clave = document.getElementById('usuario-clave').value;
        
        const isEditing = !!document.getElementById('usuario-id').value;

        if (!isEditing && rol !== ROLES.PATRON && !clave) {
            mostrarNotificacion('La clave de acceso es obligatoria para este rol.', 'error');
            return;
        }

        const nuevoUsuario = { 
            id, 
            nombre: document.getElementById('usuario-nombre').value, 
            email: document.getElementById('usuario-email').value, 
            rol: rol,
            patronId: negocioActualId
        };

        if (rol !== ROLES.PATRON && clave) {
            nuevoUsuario.claveAcceso = btoa(clave);
        }

        if (isEditing) { 
            const index = datos.usuarios.findIndex(u => u.id === id);
            // Conservar la clave si no se ingresa una nueva
            if (rol !== ROLES.PATRON && !clave) {
                nuevoUsuario.claveAcceso = datos.usuarios[index].claveAcceso;
            }
            datos.usuarios[index] = nuevoUsuario; 
        } else { 
            datos.usuarios.push(nuevoUsuario); 
        }
        
        guardarDatos('usuarios'); 
        renderizarUsuarios(); 
        cerrarModal('modal-usuario'); 
        mostrarNotificacion('Usuario guardado con éxito.', 'success');
    }

    function renderizarUsuarios() {
        const tbody = document.getElementById('tabla-usuarios'); 
        tbody.innerHTML = '';
        
        const usuariosNegocio = datos.usuarios.filter(u => u.patronId === negocioActualId && u.rol !== ROLES.PATRON);
        
        if(usuariosNegocio.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No hay usuarios secundarios registrados.</td></tr>';
            return;
        }
        
        usuariosNegocio.forEach(usuario => {
            const tr = document.createElement('tr');
            const rolClass = `rol-${usuario.rol}`;
            tr.innerHTML = `
                <td>${usuario.nombre}</td>
                <td>${usuario.email}</td>
                <td><span class="rol-badge ${rolClass}">${usuario.rol.charAt(0).toUpperCase() + usuario.rol.slice(1)}</span></td>
                <td class="actions">
                    <button class="btn btn-warning" onclick="abrirModalUsuario('${usuario.id}')">Editar</button>
                    <button class="btn btn-danger" onclick="eliminarUsuario('${usuario.id}')">Eliminar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function eliminarUsuario(id) { 
        if (confirm('¿Estás seguro de que quieres eliminar este usuario?')) { 
            datos.usuarios = datos.usuarios.filter(u => u.id !== id); 
            guardarDatos('usuarios'); 
            renderizarUsuarios(); 
            mostrarNotificacion('Usuario eliminado.', 'success'); 
        } 
    }

    // --- NAVEGACIÓN ---
    function mostrarVista(vistaId, element) {
        document.querySelectorAll('.view').forEach(vista => vista.classList.remove('active'));
        document.querySelectorAll('.nav-button').forEach(boton => boton.classList.remove('active'));
        document.getElementById(vistaId).classList.add('active');
        if (element) {
            element.classList.add('active');
        }

        if (vistaId === 'vista-inventario') renderizarInventario();
        if (vistaId === 'vista-clientes') renderizarClientes();
        if (vistaId === 'vista-proveedores') renderizarProveedores();
        if (vistaId === 'vista-cxc') renderizarCxC();
        if (vistaId === 'vista-ventas-cobradas') {
            renderizarVentasCobradas();
            renderizarListaAnuladas();
        }
        if (vistaId === 'vista-informes') renderizarInformes();
        if (vistaId === 'vista-movimientos') renderizarMovimientos();
        if (vistaId === 'vista-planes') renderizarModuloPlanes();
        if (vistaId === 'vista-pos') {
            renderizarProductosPOS();
            document.getElementById('barcode-input').focus();
        }
    }

    // --- LÓGICA DE PROVEEDORES ---
    function abrirModalProveedor(proveedorId = null) {
        document.getElementById('titulo-modal-proveedor').textContent = proveedorId ? 'Editar Proveedor' : 'Añadir Proveedor';
        const form = document.getElementById('form-proveedor'); form.reset();
        const selectProveedor = document.getElementById('producto-proveedor');
        selectProveedor.innerHTML = '<option value="">Sin Proveedor</option>';
        datos.proveedores.forEach(prov => {
            const option = document.createElement('option'); option.value = prov.id; option.textContent = prov.nombre; selectProveedor.appendChild(option);
        });
        if (proveedorId) {
            const proveedor = datos.proveedores.find(p => p.id === proveedorId);
            document.getElementById('proveedor-id').value = proveedor.id;
            document.getElementById('proveedor-nombre').value = proveedor.nombre;
            document.getElementById('proveedor-telefono').value = proveedor.telefono;
            document.getElementById('proveedor-email').value = proveedor.email;
        } else { document.getElementById('proveedor-id').value = ''; }
        document.getElementById('modal-proveedor').style.display = 'block';
    }
    function guardarProveedor(event) {
        event.preventDefault();
        const nuevoProveedor = {
            id: document.getElementById('proveedor-id').value || generarId(),
            nombre: document.getElementById('proveedor-nombre').value,
            telefono: document.getElementById('proveedor-telefono').value,
            email: document.getElementById('proveedor-email').value,
            patronId: negocioActualId
        };
        if (!validarProveedor(nuevoProveedor)) return;

        if (document.getElementById('proveedor-id').value) { 
            const index = datos.proveedores.findIndex(p => p.id === nuevoProveedor.id); 
            datos.proveedores[index] = nuevoProveedor; 
        } else { 
            datos.proveedores.push(nuevoProveedor); 
        }
        guardarDatos('proveedores'); 
        renderizarProveedores(); 
        cerrarModal('modal-proveedor'); 
        mostrarNotificacion('Proveedor guardado con éxito.', 'success');
    }
    function renderizarProveedores() {
        const tbody = document.getElementById('tabla-proveedores'); tbody.innerHTML = '';
        const proveedoresNegocio = datos.proveedores.filter(p => p.patronId === negocioActualId);
        proveedoresNegocio.forEach(prov => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${prov.nombre}</td><td>${prov.telefono}</td><td>${prov.email}</td><td class="actions"><button class="btn btn-warning" onclick="abrirModalProveedor('${prov.id}')">Editar</button><button class="btn btn-danger" onclick="eliminarProveedor('${prov.id}')">Eliminar</button></td>`;
            tbody.appendChild(tr);
        });
    }
    function eliminarProveedor(id) { if (confirm('¿Estás seguro de que quieres eliminar este proveedor?')) { datos.proveedores = datos.proveedores.filter(p => p.id !== id); guardarDatos('proveedores'); renderizarProveedores(); mostrarNotificacion('Proveedor eliminado.', 'success'); } }

    // --- LÓGICA DE RECEPCIÓN DE MERCANCÍA ---
    function abrirModalRecepcionMercancia() {
        document.getElementById('modal-recepcion-mercancia').style.display = 'block';
        document.getElementById('form-recepcion-mercancia').reset();
        document.getElementById('recepcion-fecha').value = new Date().toISOString().split('T')[0];
        
        const selectProveedor = document.getElementById('recepcion-proveedor');
        selectProveedor.innerHTML = '<option value="">Seleccionar Proveedor</option>';
        const proveedoresNegocio = datos.proveedores.filter(p => p.patronId === negocioActualId);
        proveedoresNegocio.forEach(prov => {
            const option = document.createElement('option');
            option.value = prov.id;
            option.textContent = prov.nombre;
            selectProveedor.appendChild(option);
        });
        
        document.getElementById('productos-recepcion-lista').innerHTML = '<p>Seleccione un proveedor para ver los productos.</p>';
        actualizarTotalRecepcion();
    }

    function cargarProductosProveedor() {
        const proveedorId = document.getElementById('recepcion-proveedor').value;
        const listaProductos = document.getElementById('productos-recepcion-lista');
        
        if (!proveedorId) {
            listaProductos.innerHTML = '<p>Seleccione un proveedor para ver los productos.</p>';
            return;
        }
        
        const productosProveedor = datos.productos.filter(p => p.proveedorId === proveedorId && p.patronId === negocioActualId);
        
        if (productosProveedor.length === 0) {
            listaProductos.innerHTML = '<p>Este proveedor no tiene productos registrados.</p>';
            return;
        }
        
        listaProductos.innerHTML = '';
        productosProveedor.forEach(producto => {
            const item = document.createElement('div');
            item.className = 'recepcion-product-item';
            item.innerHTML = `
                <div class="recepcion-product-item-main">
                    <input type="checkbox" id="chk-producto-${producto.id}" data-producto-id="${producto.id}" onchange="actualizarTotalRecepcion()">
                    <label for="chk-producto-${producto.id}" class="recepcion-product-info">
                        ${producto.nombre}
                        <span class="recepcion-product-actual">Stock actual: ${producto.stock}</span>
                    </label>
                </div>
                <div class="recepcion-product-details">
                    <div>
                        <label for="cantidad-${producto.id}">Cantidad</label>
                        <input type="number" id="cantidad-${producto.id}" min="1" value="1" oninput="actualizarTotalRecepcion()">
                    </div>
                    <div>
                        <label for="costo-${producto.id}">Nuevo Costo ($)</label>
                        <input type="number" id="costo-${producto.id}" step="0.01" min="0" value="${producto.costoCompra.toFixed(2)}" oninput="actualizarCalculosRecepcion('${producto.id}', 'costo')">
                    </div>
                    <div>
                        <label for="factor-${producto.id}">Factor Venta</label>
                        <input type="number" id="factor-${producto.id}" step="0.01" min="1" value="1.3" oninput="actualizarCalculosRecepcion('${producto.id}', 'factor')">
                    </div>
                    <div>
                        <label for="pvp-${producto.id}">PVP Venta ($)</label>
                        <input type="number" id="pvp-${producto.id}" step="0.01" min="0" value="${(producto.costoCompra * 1.3).toFixed(2)}" oninput="actualizarCalculosRecepcion('${producto.id}', 'pvp')" style="font-weight: bold; background-color: #e3f2fd;">
                    </div>
                </div>
            `;
            listaProductos.appendChild(item);
        });
    }

    function actualizarCalculosRecepcion(productoId, campoCambiado) {
        const costoInput = document.getElementById(`costo-${productoId}`);
        const factorInput = document.getElementById(`factor-${productoId}`);
        const pvpInput = document.getElementById(`pvp-${productoId}`);

        const costo = parseFloat(costoInput.value) || 0;
        const factor = parseFloat(factorInput.value) || 1;
        const pvp = parseFloat(pvpInput.value) || 0;

        if (campoCambiado === 'costo' || campoCambiado === 'factor') {
            if (costo > 0 && factor > 0) {
                pvpInput.value = (costo * factor).toFixed(2);
            }
        } else if (campoCambiado === 'pvp') {
            if (costo > 0 && pvp > 0) {
                factorInput.value = (pvp / costo).toFixed(2);
            }
        }

        actualizarTotalRecepcion();
    }

    function actualizarTotalRecepcion() {
        let totalCosto = 0;
        const checkboxes = document.querySelectorAll('#productos-recepcion-lista input[type="checkbox"]:checked');
        
        checkboxes.forEach(checkbox => {
            const productoId = checkbox.dataset.productoId;
            const cantidad = parseFloat(document.getElementById(`cantidad-${productoId}`).value) || 0;
            const costo = parseFloat(document.getElementById(`costo-${productoId}`).value) || 0;
            if (cantidad > 0 && costo > 0) {
                totalCosto += cantidad * costo;
            }
        });
        
        document.getElementById('simbolo-moneda-recepcion').textContent = simboloMoneda;
        document.getElementById('recepcion-total-monto').textContent = totalCosto.toFixed(2);
        document.getElementById('recepcion-total-monto-bs').textContent = (totalCosto * tasaCambio).toFixed(2);
    }

    function procesarRecepcionMercancia(event) {
        event.preventDefault();
        const proveedorId = document.getElementById('recepcion-proveedor').value;
        const numeroFactura = document.getElementById('recepcion-numero-factura').value;
        const fechaRecepcion = document.getElementById('recepcion-fecha').value;
        const notas = document.getElementById('recepcion-notas').value;
        
        if (!proveedorId) {
            mostrarNotificacion('Debe seleccionar un proveedor.', 'error');
            return;
        }
        
        const productosSeleccionados = [];
        const checkboxes = document.querySelectorAll('#productos-recepcion-lista input[type="checkbox"]:checked');
        
        if (checkboxes.length === 0) {
            mostrarNotificacion('Debe seleccionar al menos un producto para recibir.', 'error');
            return;
        }
        
        let totalCosto = 0;
        let hayErrores = false;
        
        checkboxes.forEach(checkbox => {
            if (hayErrores) return;
            const productoId = checkbox.dataset.productoId;
            const cantidad = parseInt(document.getElementById(`cantidad-${productoId}`).value);
            const nuevoCosto = parseFloat(document.getElementById(`costo-${productoId}`).value);
            const nuevoPVP = parseFloat(document.getElementById(`pvp-${productoId}`).value);
            
            if (isNaN(cantidad) || cantidad <= 0 || isNaN(nuevoCosto) || nuevoCosto < 0 || isNaN(nuevoPVP) || nuevoPVP <= 0) {
                mostrarNotificacion('Por favor, verifique que todos los campos (Cantidad, Costo, PVP) sean números válidos y positivos.', 'error');
                hayErrores = true;
                return;
            }
            
            const producto = datos.productos.find(p => p.id === productoId);
            if (producto) {
                productosSeleccionados.push({
                    id: producto.id,
                    nombre: producto.nombre,
                    cantidad: cantidad,
                    costoUnitario: nuevoCosto,
                    nuevoPVP: nuevoPVP
                });
                totalCosto += cantidad * nuevoCosto;
            }
        });
        
        if (hayErrores) return;
        
        const recepcion = {
            id: generarId(),
            proveedorId: proveedorId,
            numeroFactura: numeroFactura,
            fechaRecepcion: fechaRecepcion,
            productos: productosSeleccionados.map(p => ({ id: p.id, nombre: p.nombre, cantidad: p.cantidad, costoUnitario: p.costoUnitario })),
            totalCosto: totalCosto,
            notas: notas,
            estado: 'recibida',
            usuarioId: JSON.parse(localStorage.getItem(CLAVES_STORAGE.usuarioLogueado) || '{}').id,
            patronId: negocioActualId,
            fechaCreacion: new Date().toISOString()
        };
        
        datos.recepcionesMercancia.push(recepcion);
        guardarDatos('recepcionesMercancia');
        
        productosSeleccionados.forEach(item => {
            const index = datos.productos.findIndex(p => p.id === item.id);
            if (index !== -1) {
                datos.productos[index].stock += item.cantidad;
                datos.productos[index].costoCompra = item.costoUnitario;
                datos.productos[index].precioVenta = item.nuevoPVP;
                
                registrarMovimiento(
                    datos.productos[index].id, 
                    datos.productos[index].nombre, 
                    item.cantidad, 
                    'recepcion', 
                    `Recepción #${numeroFactura}`
                );
            }
        });
        
        guardarDatos('productos');
        
        cerrarModal('modal-recepcion-mercancia');
        mostrarNotificacion(`Mercancía recibida. Total: ${simboloMoneda}${totalCosto.toFixed(2)}`, 'success');
        
        if (document.getElementById('vista-inventario').classList.contains('active')) renderizarInventario();
        if (document.getElementById('vista-movimientos').classList.contains('active')) renderizarMovimientos();
    }

    // --- LÓGICA DE CLIENTES ---
    function abrirModalCliente(clienteId = null) {
        document.getElementById('titulo-modal-cliente').textContent = clienteId ? 'Editar Cliente' : 'Añadir Cliente';
        const form = document.getElementById('form-cliente'); form.reset();
        if (clienteId) {
            const cliente = datos.clientes.find(c => c.id === clienteId);
            document.getElementById('cliente-id').value = cliente.id;
            document.getElementById('cliente-nombre').value = cliente.nombre;
            document.getElementById('cliente-telefono').value = cliente.telefono;
            document.getElementById('cliente-email').value = cliente.email;
        } else { document.getElementById('cliente-id').value = ''; }
        document.getElementById('modal-cliente').style.display = 'block';
    }
    function guardarCliente(event) {
        event.preventDefault();
        const nuevoCliente = {
            id: document.getElementById('cliente-id').value || generarId(),
            nombre: document.getElementById('cliente-nombre').value,
            telefono: document.getElementById('cliente-telefono').value,
            email: document.getElementById('cliente-email').value,
            patronId: negocioActualId
        };
        if (!validarCliente(nuevoCliente)) return;

        if (document.getElementById('cliente-id').value) { 
            const index = datos.clientes.findIndex(c => c.id === nuevoCliente.id); 
            datos.clientes[index] = nuevoCliente; 
        } else { 
            datos.clientes.push(nuevoCliente); 
        }
        guardarDatos('clientes'); 
        renderizarClientes(); 
        cerrarModal('modal-cliente'); 
        mostrarNotificacion('Cliente guardado con éxito.', 'success');
    }
    function renderizarClientes(filtro = '') {
        const tbody = document.getElementById('tabla-clientes'); tbody.innerHTML = '';
        let clientesNegocio = datos.clientes.filter(c => c.patronId === negocioActualId);
        
        if (filtro) {
            const filtroLowerCase = filtro.toLowerCase();
            clientesNegocio = clientesNegocio.filter(c => 
                c.nombre.toLowerCase().includes(filtroLowerCase) ||
                (c.telefono && c.telefono.includes(filtro)) ||
                (c.email && c.email.toLowerCase().includes(filtroLowerCase))
            );
        }

        clientesNegocio.forEach(cli => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${cli.nombre}</td><td>${cli.telefono}</td><td>${cli.email}</td><td class="actions"><button class="btn btn-warning" onclick="abrirModalCliente('${cli.id}')">Editar</button><button class="btn btn-danger" onclick="eliminarCliente('${cli.id}')">Eliminar</button></td>`;
            tbody.appendChild(tr);
        });
    }
    function eliminarCliente(id) { if (confirm('¿Estás seguro de que quieres eliminar este cliente?')) { datos.clientes = datos.clientes.filter(c => c.id !== id); guardarDatos('clientes'); renderizarClientes(); mostrarNotificacion('Cliente eliminado.', 'success'); } }

    // --- LÓGICA DE INVENTARIO ---
    function abrirModalProducto(productoId = null) {
        imagenBase64 = null;
        document.getElementById('titulo-modal-producto').textContent = productoId ? 'Editar Producto' : 'Añadir Producto';
        const form = document.getElementById('form-producto'); form.reset();
        const preview = document.getElementById('imagen-preview');
        preview.src = "";
        preview.style.display = 'none';
        
        const selectProveedor = document.getElementById('producto-proveedor');
        selectProveedor.innerHTML = '<option value="">Sin Proveedor</option>';
        const proveedoresNegocio = datos.proveedores.filter(p => p.patronId === negocioActualId);
        proveedoresNegocio.forEach(prov => {
            const option = document.createElement('option'); option.value = prov.id; option.textContent = prov.nombre; selectProveedor.appendChild(option);
        });
        if (productoId) {
            const producto = datos.productos.find(p => p.id === productoId);
            document.getElementById('producto-id').value = producto.id;
            document.getElementById('producto-nombre').value = producto.nombre;
            document.getElementById('producto-barcode').value = producto.barcode || '';
            document.getElementById('producto-costo').value = producto.costoCompra;
            document.getElementById('producto-precio').value = producto.precioVenta;
            document.getElementById('producto-stock').value = producto.stock;
            document.getElementById('producto-proveedor').value = producto.proveedorId || '';
            if(producto.imagen) {
                imagenBase64 = producto.imagen;
                preview.src = imagenBase64;
                preview.style.display = 'block';
            }
        } else { 
            document.getElementById('producto-id').value = '';
            document.getElementById('producto-barcode').value = '';
        }
        document.getElementById('modal-producto').style.display = 'block';
    }
    async function guardarProducto(event) {
        event.preventDefault();
        const id = document.getElementById('producto-id').value;
        const stockActual = id ? datos.productos.find(p => p.id === id)?.stock || 0 : 0;
        const stockNuevo = parseInt(document.getElementById('producto-stock').value);

        const nuevoProducto = {
            id: id || generarId(),
            nombre: document.getElementById('producto-nombre').value,
            barcode: document.getElementById('producto-barcode').value.trim(),
            costoCompra: parseFloat(document.getElementById('producto-costo').value),
            precioVenta: parseFloat(document.getElementById('producto-precio').value),
            stock: stockNuevo,
            proveedorId: document.getElementById('producto-proveedor').value,
            patronId: negocioActualId
        };
        if (!validarProducto(nuevoProducto)) return;

        const imagenInput = document.getElementById('producto-imagen');
        if (imagenInput.files && imagenInput.files[0]) {
            imagenBase64 = await procesarImagen(imagenInput.files[0]);
        }
        nuevoProducto.imagen = imagenBase64;

        if (id) { 
            const index = datos.productos.findIndex(p => p.id === nuevoProducto.id);
            datos.productos[index] = nuevoProducto; 
        } else { 
            datos.productos.push(nuevoProducto); 
        }
        
        // Registrar movimiento de ajuste si el stock cambió manualmente
        if (stockNuevo !== stockActual) {
            const diferencia = stockNuevo - stockActual;
            registrarMovimiento(nuevoProducto.id, nuevoProducto.nombre, diferencia, 'ajuste', 'Ajuste manual de inventario');
        }
        
        guardarDatos('productos'); 
        renderizarInventario(); 
        renderizarProductosPOS(); 
        cerrarModal('modal-producto'); 
        mostrarNotificacion('Producto guardado con éxito.', 'success');
    }
    function renderizarInventario(filtro = '') {
        const tbody = document.getElementById('tabla-inventario'); tbody.innerHTML = '';
        let productosNegocio = datos.productos.filter(p => p.patronId === negocioActualId);

        if (filtro) {
            const filtroLowerCase = filtro.toLowerCase();
            productosNegocio = productosNegocio.filter(p => 
                p.nombre.toLowerCase().includes(filtroLowerCase) ||
                (p.barcode && p.barcode.toLowerCase().includes(filtroLowerCase))
            );
        }

        productosNegocio.forEach(prod => {
            const proveedor = datos.proveedores.find(p => p.id === prod.proveedorId);
            const tr = document.createElement('tr');
            let imagenTd = '<td><span style="color: #aaa;">Sin Imagen</span></td>';
            if(prod.imagen) {
                imagenTd = `<td><img src="${prod.imagen}" alt="${prod.nombre}" class="imagen-tabla"></td>`;
            }
            tr.innerHTML = `${imagenTd}<td>${prod.nombre}</td><td><span class="product-barcode">${prod.barcode || 'N/A'}</span></td><td>${simboloMoneda}${prod.costoCompra.toFixed(2)}</td><td>${simboloMoneda}${prod.precioVenta.toFixed(2)}</td><td>${prod.stock}</td><td>${proveedor ? proveedor.nombre : 'N/A'}</td><td class="actions"><button class="btn btn-warning" onclick="abrirModalProducto('${prod.id}')">Editar</button><button class="btn btn-danger" onclick="eliminarProducto('${prod.id}')">Eliminar</button><button class="btn btn-primary" onclick="abrirModalMovimientos('${prod.id}', '${prod.nombre}')">Movimientos</button></td>`;
            tbody.appendChild(tr);
        });
    }
    function eliminarProducto(id) { if (confirm('¿Estás seguro de que quieres eliminar este producto?')) { datos.productos = datos.productos.filter(p => p.id !== id); guardarDatos('productos'); renderizarInventario(); mostrarNotificacion('Producto eliminado.', 'success'); } }

    // --- LÓGICA DE PUNTO DE VENTA (POS) ---
    let carrito = [];
    
    function renderizarProductosPOS() {
        const lista = document.getElementById('lista-productos-pos'); lista.innerHTML = '';
        const productosNegocio = datos.productos.filter(p => p.patronId === negocioActualId);
        const productosConStock = productosNegocio.filter(p => p.stock > 0);
        if(productosConStock.length === 0) { lista.innerHTML = '<p style="padding: 10px; text-align:center; grid-column: 1 / -1;">No hay productos con stock disponibles.</p>'; return; }
        productosConStock.forEach(prod => {
            const item = document.createElement('div'); item.className = 'product-item';
            let imagenHtml = `<div style="width: 100%; height: 80px; background: #eee; border-radius: 4px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: #aaa; font-size: 0.8em;">Sin Imagen</div>`;
            if(prod.imagen) {
                imagenHtml = `<img src="${prod.imagen}" alt="${prod.nombre}" class="product-item-imagen">`;
            }
            item.innerHTML = `${imagenHtml}<div class="nombre">${prod.nombre}</div><div class="stock-info">Stock: ${prod.stock}</div><div class="precio">${simboloMoneda}${prod.precioVenta.toFixed(2)}</div>`;
            item.onclick = () => añadirAlCarrito(prod); lista.appendChild(item);
        });
    }
    
    const buscarProductosDebounced = debounce(function() {
        const termino = document.getElementById('buscar-producto').value.toLowerCase();
        const lista = document.getElementById('lista-productos-pos'); lista.innerHTML = '';
        const productosNegocio = datos.productos.filter(p => p.patronId === negocioActualId);
        const filtrados = productosNegocio.filter(p => p.nombre.toLowerCase().includes(termino) && p.stock > 0);
        if(filtrados.length === 0){ lista.innerHTML = '<p style="padding: 10px; text-align:center; grid-column: 1 / -1;">No se encontraron productos con stock.</p>'; }
        filtrados.forEach(prod => {
            const item = document.createElement('div'); item.className = 'product-item';
            let imagenHtml = `<div style="width: 100%; height: 80px; background: #eee; border-radius: 4px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: #aaa; font-size: 0.8em;">Sin Imagen</div>`;
            if(prod.imagen) {
                imagenHtml = `<img src="${prod.imagen}" alt="${prod.nombre}" class="product-item-imagen">`;
            }
            item.innerHTML = `${imagenHtml}<div class="nombre">${prod.nombre}</div><div class="stock-info">Stock: ${prod.stock}</div><div class="precio">${simboloMoneda}${prod.precioVenta.toFixed(2)}</div>`;
            item.onclick = () => añadirAlCarrito(prod); lista.appendChild(item);
        });
    }, 300);

    function añadirAlCarrito(producto) {
        const itemExistente = carrito.find(item => item.id === producto.id);
        if (itemExistente) { if (itemExistente.cantidad < producto.stock) { itemExistente.cantidad++; } else { mostrarNotificacion('No hay más stock disponible para este producto.', 'error'); return; } }
        else { carrito.push({ ...producto, cantidad: 1 }); }
        renderizarCarrito();
    }
    
    function renderizarCarrito() {
        const contenedor = document.getElementById('carrito-items'); contenedor.innerHTML = '';
        let total = 0;
        carrito.forEach((item, index) => {
            const subtotal = item.precioVenta * item.cantidad; total += subtotal;
            const div = document.createElement('div'); div.className = 'cart-item';
            div.innerHTML = `<span>${item.nombre} (x${item.cantidad})</span><span>${simboloMoneda}${subtotal.toFixed(2)}</span><button class="btn btn-danger" onclick="quitarDelCarrito(${index})" style="padding: 2px 6px;">X</button>`;
            contenedor.appendChild(div);
        });
        
        document.getElementById('carrito-total').textContent = total.toFixed(2);
        document.getElementById('carrito-total-bs').textContent = (total * tasaCambio).toFixed(2);
    }
    
    function quitarDelCarrito(index) { carrito.splice(index, 1); renderizarCarrito(); }

    function procesarVentaCredito() {
        if (carrito.length === 0) { mostrarNotificacion('El carrito está vacío.', 'error'); return; }
        if (!selectedClientId) { mostrarNotificacion('Debes seleccionar un cliente para "Pagar Después".', 'error'); return; }
        const total = parseFloat(document.getElementById('carrito-total').textContent);
        const numeroFactura = getSiguienteNumeroFactura();
        const venta = { 
            id: generarId(), 
            numeroFactura: numeroFactura, 
            clienteId: selectedClientId, 
            fecha: new Date().toISOString(), 
            productos: carrito.map(item => ({ id: item.id, nombre: item.nombre, cantidad: item.cantidad, precioUnitario: item.precioVenta })), 
            total: total, 
            estado: 'pendiente',
            pagos: [],
            patronId: negocioActualId 
        };
        carrito.forEach(itemCarrito => { const producto = datos.productos.find(p => p.id === itemCarrito.id); producto.stock -= itemCarrito.cantidad; registrarMovimiento(producto.id, producto.nombre, -itemCarrito.cantidad, 'venta', `Factura #${numeroFactura}`); });
        guardarDatos('productos');
        datos.ventas.push(venta); guardarDatos('ventas');
        const cxc = { 
            id: generarId(), 
            numeroFactura: numeroFactura, 
            clienteId: selectedClientId, 
            ventaId: venta.id, 
            monto: total, 
            saldo: total, 
            fechaCompra: venta.fecha, 
            abonos: [], 
            estado: 'pendiente',
            patronId: negocioActualId 
        };
        datos.cuentasPorCobrar.push(cxc); guardarDatos('cuentasPorCobrar');
        resetearClienteSeleccionado();
        carrito = []; renderizarCarrito(); renderizarProductosPOS(); mostrarNotificacion(`Factura ${numeroFactura} registrada a crédito.`, 'success');
    }

    // --- LÓGICA DE SELECCIÓN DE CLIENTE ---
    function abrirModalSeleccionCliente() {
        document.getElementById('buscar-cliente').value = '';
        renderizarListaClientesParaSeleccion();
        document.getElementById('modal-seleccion-cliente').style.display = 'block';
    }

    function cerrarModalSeleccionCliente() {
        document.getElementById('modal-seleccion-cliente').style.display = 'none';
    }

    const buscarClientesDebounced = debounce(function() {
        const termino = document.getElementById('buscar-cliente').value.toLowerCase();
        renderizarListaClientesParaSeleccion(termino);
    }, 300);

    function renderizarListaClientesParaSeleccion(filtro = '') {
        const lista = document.getElementById('lista-clientes-seleccion');
        lista.innerHTML = '';
        const clientesNegocio = datos.clientes.filter(c => c.patronId === negocioActualId);
        
        const filtrados = filtro ? clientesNegocio.filter(cliente => 
            cliente.nombre.toLowerCase().includes(filtro)
        ) : clientesNegocio;
        
        if (filtrados.length === 0) {
            lista.innerHTML = '<p style="padding: 20px; text-align: center;">No se encontraron clientes.</p>';
            return;
        }
        filtrados.forEach(cliente => {
            const deuda = calcularDeudaCliente(cliente.id);
            const item = document.createElement('div');
            item.className = 'cliente-seleccion-item';
            item.innerHTML = `
                <span>${cliente.nombre}</span>
                ${deuda > 0 ? `<span class="cliente-deuda">Deuda: ${simboloMoneda}${deuda.toFixed(2)}</span>` : ''}
            `;
            item.onclick = () => seleccionarCliente(cliente.id, cliente.nombre);
            lista.appendChild(item);
        });
    }

    function calcularDeudaCliente(clienteId) {
        const cxcNegocio = datos.cuentasPorCobrar.filter(c => c.patronId === negocioActualId);
        return cxcNegocio
            .filter(cxc => cxc.clienteId === clienteId)
            .reduce((total, cxc) => total + cxc.saldo, 0);
    }

    function seleccionarCliente(id, nombre) {
        selectedClientId = id;
        selectedClientName = nombre;
        document.getElementById('cliente-seleccionado-nombre').textContent = nombre;
        document.getElementById('cliente-seleccionado-info').style.display = 'block';
        cerrarModalSeleccionCliente();
    }

    function resetearClienteSeleccionado() {
        selectedClientId = null;
        selectedClientName = '';
        document.getElementById('cliente-seleccionado-info').style.display = 'none';
    }

    // --- LÓGICA DE CUENTAS POR COBRAR ---
    function renderizarCxC() {
        const tbody = document.getElementById('tabla-cxc');
        tbody.innerHTML = '';
        const searchTerm = document.getElementById('buscar-cxc').value.toLowerCase();

        const cxcNegocio = datos.cuentasPorCobrar.filter(c => c.patronId === negocioActualId);
        let pendientes = cxcNegocio.filter(cxc => cxc.estado !== 'anulada');

        // Total sobre todas las cuentas pendientes, no sobre las filtradas
        const totalSaldoPendiente = pendientes.reduce((total, cxc) => total + cxc.saldo, 0);
        document.getElementById('total-saldo-pendiente').textContent = `(Saldo Total: ${simboloMoneda}${totalSaldoPendiente.toFixed(2)})`;

        let cxcFiltradas = pendientes;
        if (searchTerm) {
            cxcFiltradas = pendientes.filter(cxc => {
                const cliente = datos.clientes.find(c => c.id === cxc.clienteId);
                const clienteNombre = cliente ? cliente.nombre.toLowerCase() : '';
                const numeroFactura = cxc.numeroFactura.toString();
                const monto = cxc.monto.toFixed(2);
                const saldo = cxc.saldo.toFixed(2);

                return clienteNombre.includes(searchTerm) ||
                       numeroFactura.includes(searchTerm) ||
                       monto.includes(searchTerm) ||
                       saldo.includes(searchTerm);
            });
        }

        if (cxcFiltradas.length === 0) {
            const message = searchTerm ? 'No se encontraron cuentas que coincidan con la búsqueda.' : 'No hay cuentas por cobrar pendientes.';
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">${message}</td></tr>`;
            return;
        }

        cxcFiltradas.forEach(cxc => {
            const cliente = datos.clientes.find(c => c.id === cxc.clienteId);
            const tr = document.createElement('tr');
            tr.className = 'deuda-pendiente';
            tr.innerHTML = `<td>${cxc.numeroFactura}</td><td>${cliente ? cliente.nombre : 'Cliente no encontrado'}</td><td>${new Date(cxc.fechaCompra).toLocaleDateString()}</td><td>${simboloMoneda}${cxc.monto.toFixed(2)}</td><td>${simboloMoneda}${cxc.saldo.toFixed(2)}</td><td class="actions"><button class="btn btn-warning" onclick="abrirModalAbono('${cxc.id}')">Abonar</button><button class="btn btn-success" onclick="cobrarTodo('${cxc.id}')">Cobrar Todo</button><button class="btn btn-primary" onclick="abrirModalEditarFactura('${cxc.ventaId}')">Editar</button><button class="btn btn-danger" onclick="anularFacturaDesdeCxc('${cxc.ventaId}')">Anular</button></td>`;
            tbody.appendChild(tr);
        });
    }

    function renderizarVentasCobradas() {
        const tbody = document.getElementById('tabla-ventas-cobradas'); tbody.innerHTML = '';
        const ventasNegocio = datos.ventasCobradas.filter(v => v.patronId === negocioActualId);
        const cobradas = ventasNegocio.filter(v => v.estado !== 'anulada');
        if(cobradas.length === 0){ tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay ventas cobradas.</td></tr>'; return; }
        cobradas.forEach(cobrada => {
            const cliente = datos.clientes.find(c => c.id === cobrada.clienteId);
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${cobrada.numeroFactura}</td><td>${cliente ? cliente.nombre : 'Venta de Contado'}</td><td>${new Date(cobrada.fechaCompra).toLocaleDateString()}</td><td>${simboloMoneda}${cobrada.monto.toFixed(2)}</td><td class="actions"><button class="btn btn-primary" onclick="abrirModalEditarFactura('${cobrada.ventaId}')">Editar</button><button class="btn btn-danger" onclick="anularFactura('${cobrada.ventaId}')">Anular</button></td>`;
            tbody.appendChild(tr);
        });
    }

    function toggleAnuladasView() {
        const contenedor = document.getElementById('contenedor-anuladas-flotante');
        contenedor.style.display = contenedor.style.display === 'none' ? 'block' : 'none';
        if(contenedor.style.display === 'block') {
            renderizarListaAnuladas();
        }
    }

    function renderizarListaAnuladas() {
        const tbody = document.getElementById('tabla-anuladas'); tbody.innerHTML = '';
        const ventasNegocio = datos.ventasCobradas.filter(v => v.patronId === negocioActualId);
        const anuladas = ventasNegocio.filter(v => v.estado === 'anulada');
        if(anuladas.length === 0){ tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay facturas anuladas.</td></tr>'; return; }
        anuladas.forEach(venta => {
            const cliente = datos.clientes.find(c => c.id === venta.clienteId);
            const tr = document.createElement('tr');
            tr.classList.add('factura-anulada');
            tr.innerHTML = `<td>${venta.numeroFactura}</td><td>${cliente ? cliente.nombre : 'Cliente no encontrado'}</td><td>${new Date(venta.fechaCompra).toLocaleDateString()}</td><td>${simboloMoneda}${venta.monto.toFixed(2)}</td><td class="actions">Anulada</td>`;
            tbody.appendChild(tr);
        });
    }

    function abrirModalAbono(cxcId) {
        const cxc = datos.cuentasPorCobrar.find(c => c.id === cxcId);
        if (!cxc) return;
        document.getElementById('info-abono').textContent = `Saldo actual de la factura #${cxc.numeroFactura}: ${simboloMoneda}${cxc.saldo.toFixed(2)}`;
        document.getElementById('form-abono').onsubmit = function(e) { guardarAbono(e, cxcId); };
        document.getElementById('modal-abono').style.display = 'block';
    }

    function guardarAbono(event, cxcId) {
        event.preventDefault();
        const montoAbono = parseFloat(document.getElementById('abono-monto').value);
        const cxc = datos.cuentasPorCobrar.find(c => c.id === cxcId);
        if (!cxc || montoAbono <= 0) { mostrarNotificacion('Monto de abono no válido.', 'error'); return; }
        if (montoAbono > cxc.saldo) { mostrarNotificacion('El abono no puede ser mayor al saldo pendiente.', 'error'); return; }

        cxc.abonos.push({ monto: montoAbono, fecha: new Date().toISOString() });
        cxc.saldo -= montoAbono;
        
        guardarDatos('cuentasPorCobrar');
        
        if (cxc.saldo <= 0.005) { // Handle floating point inaccuracies
            moverAVentasCobradas(cxcId);
        } else {
            renderizarCxC();
        }
        
        cerrarModal('modal-abono');
        document.getElementById('form-abono').reset();
        mostrarNotificacion('Abono registrado con éxito.', 'success');
    }

    function cobrarTodo(cxcId) {
        const cxc = datos.cuentasPorCobrar.find(c => c.id === cxcId);
        if (!cxc) return;
        if (confirm(`¿Estás seguro de que quieres marcar la factura #${cxc.numeroFactura} como pagada por completo?`)) {
            moverAVentasCobradas(cxcId);
        }
    }

    function moverAVentasCobradas(cxcId) {
        const index = datos.cuentasPorCobrar.findIndex(c => c.id === cxcId);
        if (index !== -1) {
            const cuentaPagada = datos.cuentasPorCobrar.splice(index, 1)[0];
            cuentaPagada.saldo = 0;
            cuentaPagada.fechaPago = new Date().toISOString();
            cuentaPagada.estado = 'pagada';
            datos.ventasCobradas.push(cuentaPagada);
            guardarDatos('cuentasPorCobrar');
            guardarDatos('ventasCobradas');
            renderizarCxC();
            renderizarVentasCobradas();
            mostrarNotificacion('Factura marcada como pagada y movida a ventas cobradas.', 'success');
        }
    }

    // --- LÓGICA DE ANULACIÓN DE FACTURA ---
    function anularFacturaDesdeCxc(ventaId) {
        const venta = findVentaById(ventaId);
        const cxcIndex = datos.cuentasPorCobrar.findIndex(c => c.ventaId === ventaId);

        if (!venta || cxcIndex === -1) {
            mostrarNotificacion('No se puede anular esta factura.', 'error');
            return;
        }

        const cxc = datos.cuentasPorCobrar[cxcIndex];

        if (!confirm(`¿Estás seguro de que quieres anular la factura #${cxc.numeroFactura}? El inventario será devuelto.`)) {
            return;
        }

        venta.productos.forEach(prod => {
            const productoEnInventario = datos.productos.find(p => p.id === prod.id);
            if (productoEnInventario) {
                productoEnInventario.stock += prod.cantidad;
                registrarMovimiento(productoEnInventario.id, productoEnInventario.nombre, prod.cantidad, 'devolucion', `Anulación Factura #${cxc.numeroFactura}`);
            }
        });

        cxc.estado = 'anulada';
        cxc.fechaAnulacion = new Date().toISOString();
        venta.estado = 'anulada';

        const cuentaAnulada = datos.cuentasPorCobrar.splice(cxcIndex, 1)[0];
        datos.ventasCobradas.push(cuentaAnulada);

        guardarDatos('productos');
        guardarDatos('ventas');
        guardarDatos('cuentasPorCobrar');
        guardarDatos('ventasCobradas');

        renderizarCxC();
        renderizarInventario();
        renderizarVentasCobradas();
        mostrarNotificacion(`Factura #${cxc.numeroFactura} anulada e inventario devuelto.`, 'success');
    }

    function anularFactura(ventaId) {
        const venta = findVentaById(ventaId);
        const cobrada = datos.ventasCobradas.find(c => c.ventaId === ventaId);

        if (!venta || !cobrada || cobrada.estado === 'anulada') {
            mostrarNotificacion('No se puede anular esta factura.', 'error');
            return;
        }

        if (!confirm(`¿Estás seguro de que quieres anular la factura #${cobrada.numeroFactura}? El inventario será devuelto.`)) {
            return;
        }

        venta.productos.forEach(prod => {
            const productoEnInventario = datos.productos.find(p => p.id === prod.id);
            if (productoEnInventario) {
                productoEnInventario.stock += prod.cantidad;
                registrarMovimiento(productoEnInventario.id, productoEnInventario.nombre, prod.cantidad, 'devolucion', `Anulación Factura #${cobrada.numeroFactura}`);
            }
        });

        cobrada.estado = 'anulada';
        cobrada.fechaAnulacion = new Date().toISOString();
        venta.estado = 'anulada';

        guardarDatos('productos');
        guardarDatos('ventas');
        guardarDatos('ventasCobradas');

        renderizarVentasCobradas();
        renderizarInventario();
        mostrarNotificacion(`Factura #${cobrada.numeroFactura} anulada e inventario devuelto.`, 'success');
    }

    // --- LÓGICA DE EDICIÓN DE FACTURA ---
    function abrirModalEditarFactura(ventaId) {
        const venta = findVentaById(ventaId);
        if (!venta || venta.estado === 'anulada') {
            mostrarNotificacion('No se puede editar una factura anulada.', 'error');
            return;
        }

        document.getElementById('editar-venta-id').value = ventaId;
        const infoDiv = document.getElementById('info-factura-editar');
        const cliente = datos.clientes.find(c => c.id === venta.clienteId);
        infoDiv.innerHTML = `<p><strong>N° Factura:</strong> ${venta.numeroFactura}</p><p><strong>Cliente:</strong> ${cliente ? cliente.nombre : 'Venta de Contado'}</p><p><strong>Fecha:</strong> ${new Date(venta.fecha).toLocaleDateString()}</p><p><strong>Total Original:</strong> ${simboloMoneda}${venta.total.toFixed(2)}</p>`;

        const tabla = document.getElementById('tabla-productos-editar');
        tabla.innerHTML = '';
        venta.productos.forEach(producto => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${producto.nombre}</td>
                <td>${producto.cantidad}</td>
                <td><input type="number" id="edit-qty-${producto.id}" value="${producto.cantidad}" class="input-cantidad-editar" min="0"></td>
            `;
            tabla.appendChild(tr);
        });

        document.getElementById('modal-editar-factura').style.display = 'block';
    }

    function guardarCambiosFactura(event) {
        event.preventDefault();
        const ventaId = document.getElementById('editar-venta-id').value;
        const venta = findVentaById(ventaId);
        if (!venta) return;

        let nuevoTotal = 0;
        const stockAdjustments = new Map();

        for (const productoOriginal of venta.productos) {
            const nuevaCantidad = parseInt(document.getElementById(`edit-qty-${productoOriginal.id}`).value) || 0;
            const diferencia = nuevaCantidad - productoOriginal.cantidad;
            
            if (diferencia !== 0) {
                const productoEnInventario = datos.productos.find(p => p.id === productoOriginal.id);
                if (productoEnInventario) {
                    if (productoEnInventario.stock - diferencia < 0) {
                        mostrarNotificacion(`Error: No hay suficiente stock para el producto "${productoEnInventario.nombre}". Stock actual: ${productoEnInventario.stock}, Intento de cambio: ${diferencia}.`, 'error');
                        return;
                    }
                    stockAdjustments.set(productoOriginal.id, diferencia);
                    productoOriginal.cantidad = nuevaCantidad;
                }
            }
            nuevoTotal += nuevaCantidad * productoOriginal.precioUnitario;
        }

        stockAdjustments.forEach((diferencia, productoId) => {
            const producto = datos.productos.find(p => p.id === productoId);
            if (producto) {
                producto.stock -= diferencia;
            }
        });

        const diferenciaTotal = nuevoTotal - venta.total;
        venta.total = nuevoTotal;
        
        const cxc = datos.cuentasPorCobrar.find(c => c.ventaId === ventaId);
        if (cxc) {
            cxc.monto = nuevoTotal;
            cxc.saldo += diferenciaTotal;
        }
        const cobrada = datos.ventasCobradas.find(c => c.ventaId === ventaId);
        if (cobrada) {
            cobrada.monto = nuevoTotal;
        }

        guardarDatos('productos');
        guardarDatos('ventas');
        guardarDatos('cuentasPorCobrar');
        guardarDatos('ventasCobradas');

        cerrarModalEditarFactura();
        renderizarCxC();
        renderizarVentasCobradas();
        renderizarInventario();
        mostrarNotificacion('Factura editada e inventario actualizado correctamente.', 'success');
    }

    // --- LÓGICA DE MOVIMIENTOS MEJORADA ---
    function renderizarMovimientos() {
        const tbody = document.getElementById('tabla-movimientos');
        tbody.innerHTML = '';
        
        const filtroProductoSelect = document.getElementById('filtro-producto-movimiento');
        const valorActual = filtroProductoSelect.value;
        filtroProductoSelect.innerHTML = '<option value="">Todos</option>';
        const productosNegocio = datos.productos.filter(p => p.patronId === negocioActualId);
        productosNegocio.forEach(prod => {
            const option = document.createElement('option');
            option.value = prod.id;
            option.textContent = prod.nombre;
            filtroProductoSelect.appendChild(option);
        });
        filtroProductoSelect.value = valorActual;

        const tipoFiltro = document.getElementById('filtro-tipo-movimiento').value;
        const productoFiltro = document.getElementById('filtro-producto-movimiento').value;
        const fechaFiltro = document.getElementById('filtro-fecha-movimiento').value;
        
        let movimientosFiltrados = datos.movimientosInventario.filter(m => m.patronId === negocioActualId);
        
        if (tipoFiltro) movimientosFiltrados = movimientosFiltrados.filter(m => m.tipo === tipoFiltro);
        if (productoFiltro) movimientosFiltrados = movimientosFiltrados.filter(m => m.productoId === productoFiltro);
        if (fechaFiltro) movimientosFiltrados = movimientosFiltrados.filter(m => new Date(m.fecha).toISOString().split('T')[0] === fechaFiltro);
        
        movimientosFiltrados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        
        renderizarResumenMovimientos(movimientosFiltrados);
        
        if(movimientosFiltrados.length === 0){
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No hay movimientos registrados con los filtros seleccionados.</td></tr>';
            return;
        }
        
        movimientosFiltrados.forEach(mov => {
            const tr = document.createElement('tr');
            const tipoClass = `movimiento-tipo-badge ${mov.tipo}`;
            tr.innerHTML = `
                <td>${new Date(mov.fecha).toLocaleString()}</td>
                <td><span class="${tipoClass}">${mov.tipo.charAt(0).toUpperCase() + mov.tipo.slice(1)}</span></td>
                <td>${mov.productoNombre}</td>
                <td>${mov.cantidad > 0 ? '+' : ''}${mov.cantidad}</td>
                <td>${mov.referencia}</td>
                <td>${datos.usuarios.find(u => u.id === mov.usuarioId)?.nombre || 'Sistema'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderizarResumenMovimientos(movimientos) {
        const resumenDiv = document.getElementById('movimiento-resumen');
        
        const resumen = movimientos.reduce((acc, mov) => {
            const tipo = mov.tipo;
            if (!acc[tipo]) acc[tipo] = 0;
            acc[tipo] += Math.abs(mov.cantidad);
            return acc;
        }, {});
        
        resumenDiv.innerHTML = `
            <div class="movimiento-resumen-card"><h4>Ventas</h4><p>${resumen.venta || 0}</p></div>
            <div class="movimiento-resumen-card"><h4>Recepciones</h4><p>${resumen.recepcion || 0}</p></div>
            <div class="movimiento-resumen-card"><h4>Devoluciones</h4><p>${resumen.devolucion || 0}</p></div>
            <div class="movimiento-resumen-card"><h4>Ajustes</h4><p>${resumen.ajuste || 0}</p></div>
        `;
    }

    function exportarMovimientos() {
        const movimientos = datos.movimientosInventario.filter(m => m.patronId === negocioActualId);
        const csvContent = "data:text/csv;charset=utf-8," 
            + ["Fecha", "Tipo", "Producto", "Cantidad", "Referencia", "Usuario"].join(",") + "\n"
            + movimientos.map(m => [
                `"${new Date(m.fecha).toLocaleString()}"`,
                m.tipo,
                `"${m.productoNombre.replace(/"/g, '""')}"`,
                m.cantidad,
                `"${m.referencia.replace(/"/g, '""')}"`,
                `"${(datos.usuarios.find(u => u.id === m.usuarioId)?.nombre || 'Sistema').replace(/"/g, '""')}"`
            ].join(",")).join("\n");
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `movimientos_inventario_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        mostrarNotificacion('Reporte de movimientos exportado exitosamente.', 'success');
    }

    function abrirModalMovimientos(productoId, productoNombre) {
        document.getElementById('titulo-movimientos').textContent = `Movimientos de: ${productoNombre}`;
        const tbody = document.getElementById('tabla-movimientos-producto-especifico');
        tbody.innerHTML = '';
        const movimientos = datos.movimientosInventario.filter(m => m.productoId === productoId).sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        if(movimientos.length === 0){
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No hay movimientos registrados.</td></tr>';
        } else {
            movimientos.forEach(mov => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${new Date(mov.fecha).toLocaleString()}</td><td><span class="movimiento-tipo-badge ${mov.tipo}">${mov.tipo.charAt(0).toUpperCase() + mov.tipo.slice(1)}</span></td><td>${mov.cantidad}</td><td>${mov.referencia}</td>`;
                tbody.appendChild(tr);
            });
        }
        document.getElementById('modal-movimientos-producto').style.display = 'block';
    }

    function cerrarModalMovimientos() {
        document.getElementById('modal-movimientos-producto').style.display = 'none';
    }

    // --- LÓGICA DE CALCULADORA MEJORADA ---
    const calcState = {
        displayValue: '0',
        firstOperand: null,
        waitingForSecondOperand: false,
        operator: null,
    };

    function abrirModalCalculadora() {
        document.getElementById('modal-calculadora').style.display = 'block';
        resetCalculator();
    }
    
    function updateCalculatorDisplay() {
        const display = document.getElementById('calc-display');
        display.textContent = calcState.displayValue;
    }

    function inputDigit(digit) {
        const { displayValue, waitingForSecondOperand } = calcState;
        if (waitingForSecondOperand === true) {
            calcState.displayValue = digit;
            calcState.waitingForSecondOperand = false;
        } else {
            if (displayValue.length >= 15) return;
            calcState.displayValue = displayValue === '0' ? digit : displayValue + digit;
        }
        updateCalculatorDisplay();
    }

    function inputDecimal(dot) {
        if (calcState.waitingForSecondOperand) {
            calcState.displayValue = '0.';
            calcState.waitingForSecondOperand = false;
            return;
        }
        if (!calcState.displayValue.includes(dot)) {
            calcState.displayValue += dot;
        }
        updateCalculatorDisplay();
    }

    function handleOperator(nextOperator) {
        const { firstOperand, displayValue, operator } = calcState;
        const inputValue = parseFloat(displayValue);

        if (operator && calcState.waitingForSecondOperand) {
            calcState.operator = nextOperator;
            return;
        }

        if (firstOperand == null && !isNaN(inputValue)) {
            calcState.firstOperand = inputValue;
        } else if (operator) {
            const result = performCalculation[operator](firstOperand, inputValue);
             if (!isFinite(result)) {
                calcState.displayValue = 'Error';
                updateCalculatorDisplay();
                setTimeout(resetCalculator, 1500);
                return;
            }
            calcState.displayValue = `${parseFloat(result.toPrecision(12))}`;
            calcState.firstOperand = result;
        }

        calcState.waitingForSecondOperand = true;
        calcState.operator = nextOperator;
        updateCalculatorDisplay();
    }

    const performCalculation = {
        '/': (first, second) => first / second,
        '*': (first, second) => first * second,
        '+': (first, second) => first + second,
        '-': (first, second) => first - second,
        '=': (first, second) => second,
    };
    
    function resetCalculator() {
        calcState.displayValue = '0';
        calcState.firstOperand = null;
        calcState.waitingForSecondOperand = false;
        calcState.operator = null;
        updateCalculatorDisplay();
    }
    
    function deleteLastDigit() {
        if (calcState.displayValue.length > 1) {
            calcState.displayValue = calcState.displayValue.slice(0, -1);
        } else {
            calcState.displayValue = '0';
        }
        updateCalculatorDisplay();
    }
    
    function handleCalculatorKeyboard(event) {
        if (document.getElementById('modal-calculadora').style.display !== 'block') return;
        const { key } = event;
        const button = document.querySelector(`.calc-btn[data-key="${key}"]`);
        if (button) {
            event.preventDefault();
            button.click();
            button.classList.add('active');
            setTimeout(() => button.classList.remove('active'), 100);
        }
    }


    // --- LÓGICA DE INFORMES ---
    function generarInforme(periodo = 'mes') {
        const ventas = [...datos.ventasCobradas, ...datos.cuentasPorCobrar].filter(v => v.patronId === negocioActualId && v.estado !== 'anulada');
        const fechaActual = new Date();
        let fechaInicio;
        
        if (periodo === 'dia') {
            fechaInicio = new Date(fechaActual.setHours(0, 0, 0, 0));
        } else if (periodo === 'semana') {
            fechaInicio = new Date();
            fechaInicio.setDate(fechaInicio.getDate() - 7);
        } else { // mes
            fechaInicio = new Date(fechaActual.getFullYear(), fechaActual.getMonth(), 1);
        }
        
        const ventasPeriodo = ventas.filter(v => new Date(v.fechaCompra) >= fechaInicio);
        const totalVentas = ventasPeriodo.reduce((total, v) => total + v.monto, 0);
        
        const productosVendidos = {};
        ventasPeriodo.forEach(v => {
            const ventaOriginal = datos.ventas.find(vo => vo.id === v.ventaId);
            if (ventaOriginal && ventaOriginal.productos) {
                ventaOriginal.productos.forEach(p => {
                    productosVendidos[p.id] = productosVendidos[p.id] || { nombre: p.nombre, cantidad: 0, total: 0 };
                    productosVendidos[p.id].cantidad += p.cantidad;
                    productosVendidos[p.id].total += p.cantidad * p.precioUnitario;
                });
            }
        });
        
        // Calcular Gastos
        const recepcionesPeriodo = datos.recepcionesMercancia.filter(r => new Date(r.fechaCreacion) >= fechaInicio && r.patronId === negocioActualId);
        const costoRecepciones = recepcionesPeriodo.reduce((total, r) => total + r.totalCosto, 0);

        const ajustesNegativos = datos.movimientosInventario.filter(m => 
            m.patronId === negocioActualId && 
            m.tipo === 'ajuste' && 
            m.cantidad < 0 && 
            new Date(m.fecha) >= fechaInicio
        );
        const costoAjustes = ajustesNegativos.reduce((total, m) => {
            const producto = datos.productos.find(p => p.id === m.productoId);
            return producto ? total + (producto.costoCompra * Math.abs(m.cantidad)) : total;
        }, 0);

        const totalGastos = costoRecepciones + costoAjustes;
        const gananciaBruta = totalVentas - totalGastos;
        
        return {
            totalVentas,
            totalGastos,
            gananciaBruta,
            cantidadVentas: ventasPeriodo.length,
            productosMasVendidos: Object.values(productosVendidos).sort((a, b) => b.cantidad - a.cantidad).slice(0, 5)
        };
    }

    function renderizarInformes() {
        const periodo = document.getElementById('informe-periodo').value;
        const informe = generarInforme(periodo);
        const contenidoDiv = document.getElementById('informe-contenido');

        const productosHtml = informe.productosMasVendidos.length > 0 ? `
            <h3>Top 5 Productos Más Vendidos</h3>
            <ul class="top-products-list">
                ${informe.productosMasVendidos.map(p => `
                    <li>
                        <span>${p.nombre}</span>
                        <span>${p.cantidad} unds (${simboloMoneda}${p.total.toFixed(2)})</span>
                    </li>
                `).join('')}
            </ul>
        ` : '<p>No hay datos de ventas de productos en este período.</p>';

        contenidoDiv.innerHTML = `
            <div class="informes-summary">
                <div class="informe-card" style="border-left-color: var(--success-color);"><h3 style="color: var(--success-color);">Total Ingresos</h3><p style="color: var(--success-color);">${simboloMoneda}${informe.totalVentas.toFixed(2)}</p></div>
                <div class="informe-card" style="border-left-color: var(--danger-color);"><h3 style="color: var(--danger-color);">Total Gastos</h3><p style="color: var(--danger-color);">${simboloMoneda}${informe.totalGastos.toFixed(2)}</p></div>
                <div class="informe-card" style="border-left-color: var(--secondary-color);"><h3 style="color: var(--secondary-color);">Ganancia Bruta</h3><p style="color: var(--secondary-color);">${simboloMoneda}${informe.gananciaBruta.toFixed(2)}</p></div>
                <div class="informe-card" style="border-left-color: var(--warning-color);"><h3 style="color: var(--warning-color);">N° de Ventas</h3><p style="color: var(--warning-color);">${informe.cantidadVentas}</p></div>
            </div>
            ${productosHtml}
        `;
    }

    function actualizarTasaCambioDesdeInformes(event) {
        event.preventDefault();
        const nuevaTasa = parseFloat(document.getElementById('nueva-tasa-cambio').value);
        if (isNaN(nuevaTasa) || nuevaTasa <= 0) {
            mostrarNotificacion('Por favor, ingrese una tasa de cambio válida.', 'error');
            return;
        }

        const patron = datos.usuarios.find(u => u.id === negocioActualId);
        if (patron) {
            patron.tasaCambio = nuevaTasa;
            patron.ultimaActualizacionTasa = new Date().toISOString();
            
            const index = datos.usuarios.findIndex(u => u.id === patron.id);
            if(index !== -1) datos.usuarios[index] = patron;
            guardarDatos('usuarios');
            
            actualizarTasaDeCambioEnUI(nuevaTasa);
            document.getElementById('ultima-actualizacion-tasa').textContent = new Date(patron.ultimaActualizacionTasa).toLocaleString();
            mostrarNotificacion('Tasa de cambio actualizada con éxito.', 'success');
        }
    }
    
    // --- LÓGICA DE PAGO MIXTO ---
    function abrirModalPago() {
        if (carrito.length === 0) {
            mostrarNotificacion('El carrito está vacío.', 'error');
            return;
        }
        pagosTemporales = [];
        actualizarModalPago();
        document.getElementById('modal-pago').style.display = 'block';
        document.getElementById('pago-monto-input').focus();
    }

    function agregarPago() {
        const montoInput = document.getElementById('pago-monto-input');
        const monedaSelect = document.getElementById('pago-moneda-select');
        const monto = parseFloat(montoInput.value);

        if (isNaN(monto) || monto <= 0) {
            mostrarNotificacion('Por favor, ingrese un monto válido.', 'error');
            return;
        }

        pagosTemporales.push({
            monto: monto,
            moneda: monedaSelect.value
        });
        
        montoInput.value = '';
        actualizarModalPago();
        montoInput.focus();
    }

    function actualizarModalPago() {
        const totalVenta = carrito.reduce((sum, item) => sum + item.precioVenta * item.cantidad, 0);
        
        document.getElementById('pago-total-usd').textContent = `${simboloMoneda}${totalVenta.toFixed(2)}`;
        document.getElementById('pago-total-bs').textContent = `Bs. ${(totalVenta * tasaCambio).toFixed(2)}`;

        const listaPagos = document.getElementById('lista-pagos');
        listaPagos.innerHTML = '';
        pagosTemporales.forEach((pago, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <span>${pago.moneda === 'dolares' ? '💵' : '🪙'} ${pago.monto.toFixed(2)} ${pago.moneda === 'dolares' ? '$' : 'Bs.'}</span>
                <button class="btn-danger" style="padding: 2px 8px;" onclick="eliminarPago(${index})">X</button>
            `;
            listaPagos.appendChild(li);
        });
        
        const totalPagadoUSD = pagosTemporales.reduce((sum, pago) => {
            const montoEnUSD = pago.moneda === 'dolares' ? pago.monto : pago.monto / tasaCambio;
            return sum + montoEnUSD;
        }, 0);

        document.getElementById('pago-total-pagado').textContent = `${simboloMoneda}${totalPagadoUSD.toFixed(2)}`;

        const balance = totalPagadoUSD - totalVenta;
        const balanceCard = document.getElementById('pago-balance-card');
        const balanceTitulo = document.getElementById('pago-balance-titulo');
        const balanceMonto = document.getElementById('pago-balance-monto');
        const balanceMontoBs = document.getElementById('pago-balance-monto-bs');

        balanceCard.className = 'payment-balance-card';
        if (balance >= -0.005) { // Pagado o con vuelto
            balanceCard.classList.add('change-card');
            balanceTitulo.textContent = 'Vuelto';
        } else { // Faltante
            balanceCard.classList.add('due-card');
            balanceTitulo.textContent = 'Faltante';
        }
        
        balanceMonto.textContent = `${simboloMoneda}${Math.abs(balance).toFixed(2)}`;
        balanceMontoBs.textContent = `Bs. ${(Math.abs(balance) * tasaCambio).toFixed(2)}`;
        
        document.getElementById('btn-finalizar-venta').disabled = balance < -0.005;
    }

    function eliminarPago(index) {
        pagosTemporales.splice(index, 1);
        actualizarModalPago();
    }

    function finalizarVentaContado() {
        const totalVenta = carrito.reduce((sum, item) => sum + item.precioVenta * item.cantidad, 0);
        const numeroFactura = getSiguienteNumeroFactura();
        
        const venta = {
            id: generarId(),
            numeroFactura,
            clienteId: selectedClientId,
            fecha: new Date().toISOString(),
            productos: carrito.map(item => ({ id: item.id, nombre: item.nombre, cantidad: item.cantidad, precioUnitario: item.precioVenta })),
            total: totalVenta,
            estado: 'pagada',
            pagos: pagosTemporales,
            patronId: negocioActualId
        };
        
        // La venta original siempre se guarda
        datos.ventas.push(venta);
        guardarDatos('ventas');
        
        // Crear registro en ventas cobradas
        const ventaCobrada = {
            ventaId: venta.id,
            numeroFactura,
            clienteId: selectedClientId,
            fechaCompra: venta.fecha,
            fechaPago: new Date().toISOString(),
            monto: totalVenta,
            estado: 'pagada',
            patronId: negocioActualId
        };
        datos.ventasCobradas.push(ventaCobrada);
        guardarDatos('ventasCobradas');
        
        // Actualizar inventario y movimientos
        carrito.forEach(item => {
            const index = datos.productos.findIndex(p => p.id === item.id);
            if (index !== -1) {
                datos.productos[index].stock -= item.cantidad;
                registrarMovimiento(item.id, item.nombre, -item.cantidad, 'venta', `Factura #${numeroFactura}`);
            }
        });
        guardarDatos('productos');
        
        // Resetear
        carrito = [];
        pagosTemporales = [];
        resetearClienteSeleccionado();
        cerrarModal('modal-pago');
        renderizarCarrito();
        renderizarProductosPOS();
        mostrarNotificacion(`Venta #${numeroFactura} registrada con éxito.`, 'success');
    }

    // --- LÓGICA DE PLANES DE AHORRO (SAM) ---
    let planEnCreacion = { participants: [] };

    function renderizarModuloPlanes() {
        renderizarPlanesLista();
    }

    function renderizarPlanesLista() {
        const container = document.getElementById('planes-module-container');
        const planesUsuario = datos.planes.filter(p => p.patronId === negocioActualId);

        let listHtml = planesUsuario.length > 0 
            ? planesUsuario.map(plan => `
                <div class="plan-list-item" data-plan-id="${plan.id}">
                    <div class="info">
                        <h3>${plan.name}</h3>
                        <p>${plan.participants.length} participantes</p>
                    </div>
                    <span class="status status-${plan.status}">${plan.status}</span>
                </div>`).join('') 
            : '<div class="plan-card" style="text-align: center; color: #777;">No tienes planes aún. ¡Crea uno!</div>';

        container.innerHTML = `
            <h2>Planes de Ahorro (SAN)</h2>
            <button class="btn btn-primary" id="btn-crear-plan">+ Crear Nuevo Plan</button>
            <div id="plans-list-container" style="margin-top: 20px;">
                ${listHtml}
            </div>
        `;

        document.getElementById('btn-crear-plan').onclick = renderizarCrearPlan;
        document.querySelectorAll('.plan-list-item').forEach(item => {
            item.onclick = () => renderizarDetallePlan(item.dataset.planId);
        });
    }

    function renderizarCrearPlan() {
        planEnCreacion = { participants: [] };
        const container = document.getElementById('planes-module-container');
        container.innerHTML = `
            <div class="plan-card">
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h3 style="margin:0;" class="plan-card-title">Crear Nuevo Plan</h3>
                    <button class="back-btn-header" onclick="renderizarPlanesLista()">← Volver a la Lista</button>
                </div>
                <form id="form-crear-plan">
                    <div class="wizard-section">
                        <div class="wizard-section-title">1. Información Básica</div>
                        <div class="form-group"><label for="plan-name">Nombre del Plan</label><input type="text" id="plan-name" placeholder="Ej: Viaje a Cancún" required></div>
                        <div class="form-group"><label for="plan-start-date">Fecha del Primer Pago</label><input type="date" id="plan-start-date" required></div>
                    </div>
                    <div class="wizard-section">
                        <div class="wizard-section-title">2. Reglas</div>
                        <div class="form-group"><label for="plan-amount">Cuota por Persona (${simboloMoneda})</label><input type="number" id="plan-amount" placeholder="Ej: 250" required></div>
                        <div class="form-group"><label for="plan-frequency">Frecuencia de Pago</label><select id="plan-frequency"><option value="Mensual" selected>Mensual</option><option value="Quincenal">Quincenal</option><option value="Semanal">Semanal</option></select></div>
                    </div>
                     <div class="wizard-section">
                        <div class="wizard-section-title">3. Participantes</div>
                        <div id="participants-list-container"></div>
                        <div class="form-group">
                            <label for="new-participant-name">Añadir Participante</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="new-participant-name" placeholder="Nombre completo" style="flex-grow: 1;">
                                <button type="button" class="btn btn-primary" onclick="agregarParticipantePlan()">+</button>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">Guardar y Asignar Turnos →</button>
                </form>
            </div>
        `;
        document.getElementById('plan-start-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('form-crear-plan').onsubmit = (e) => {
            e.preventDefault();
            if (planEnCreacion.participants.length < 2) {
                mostrarNotificacion('Debe agregar al menos 2 participantes.', 'error');
                return;
            }
            planEnCreacion.name = document.getElementById('plan-name').value;
            planEnCreacion.amount = parseFloat(document.getElementById('plan-amount').value);
            planEnCreacion.frequency = document.getElementById('plan-frequency').value;
            planEnCreacion.startDate = document.getElementById('plan-start-date').value;
            renderizarAsignarTurnos();
        };
    }
    
    function renderizarParticipantesPlan() {
        const container = document.getElementById('participants-list-container');
        container.innerHTML = '';
        planEnCreacion.participants.forEach((name, index) => {
            const item = document.createElement('div');
            item.className = 'participant-list-item';
            item.innerHTML = `<span>${name}</span><button type="button" class="btn btn-danger btn-sm" onclick="removerParticipantePlan(${index})">X</button>`;
            container.appendChild(item);
        });
    }

    function agregarParticipantePlan() {
        const input = document.getElementById('new-participant-name');
        const name = input.value.trim();
        if (name) {
            planEnCreacion.participants.push(name);
            input.value = '';
            renderizarParticipantesPlan();
        }
    }
    
    function removerParticipantePlan(index) {
        planEnCreacion.participants.splice(index, 1);
        renderizarParticipantesPlan();
    }

    function renderizarAsignarTurnos() {
        const container = document.getElementById('planes-module-container');
        let turnosHtml = planEnCreacion.participants.map((name, i) => `
             <div class="participant-list-item">
                <span>Turno ${i + 1}</span>
                <select class="form-group" id="turn-select-${i}">
                    ${planEnCreacion.participants.map(p => `<option value="${p}" ${p === name ? 'selected' : ''}>${p}</option>`).join('')}
                </select>
             </div>
        `).join('');

        container.innerHTML = `
            <div class="plan-card">
                 <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px;">
                    <h3 style="margin:0;" class="plan-card-title">Asignar Turnos</h3>
                    <button class="back-btn-header" onclick="renderizarCrearPlan()">← Volver</button>
                </div>
                <div id="turns-list-container">${turnosHtml}</div>
                <button class="btn plan-btn-outline" style="width: 100%; margin-top: 15px;" onclick="sortearTurnosPlan()">Sortear Turnos Automáticamente</button>
                <button class="btn btn-success" style="width: 100%;" onclick="finalizarCreacionPlan()">Finalizar y Activar Plan</button>
            </div>
        `;
    }

    function sortearTurnosPlan() {
        const shuffled = [...planEnCreacion.participants].sort(() => 0.5 - Math.random());
        shuffled.forEach((name, i) => {
            const select = document.getElementById(`turn-select-${i}`);
            if(select) select.value = name;
        });
        mostrarNotificacion('Turnos sorteados aleatoriamente.', 'info');
    }
    
    function finalizarCreacionPlan() {
        const turnosAsignados = [];
        const receptores = new Set();
        for(let i=0; i<planEnCreacion.participants.length; i++) {
            const receptor = document.getElementById(`turn-select-${i}`).value;
            turnosAsignados.push({ receptor });
            receptores.add(receptor);
        }

        if(receptores.size !== planEnCreacion.participants.length) {
            mostrarNotificacion('Cada participante debe ser asignado a un único turno.', 'error');
            return;
        }

        const nuevoPlan = {
            id: generarId(),
            patronId: negocioActualId,
            name: planEnCreacion.name,
            amount: planEnCreacion.amount,
            frequency: planEnCreacion.frequency,
            startDate: planEnCreacion.startDate,
            participants: planEnCreacion.participants,
            status: 'active',
            currentCycle: 1,
            cycles: turnosAsignados.map((turno, index) => ({
                receptor: turno.receptor,
                paid: false,
                date: calcularFechaPagoPlan(planEnCreacion.startDate, planEnCreacion.frequency, index + 1)
            }))
        };
        datos.planes.push(nuevoPlan);
        guardarDatos('planes');
        mostrarNotificacion(`Plan "${nuevoPlan.name}" creado y activado.`, 'success');
        renderizarDetallePlan(nuevoPlan.id);
    }

    function renderizarDetallePlan(planId) {
        const plan = datos.planes.find(p => p.id === planId);
        if(!plan) { renderizarPlanesLista(); return; }

        const container = document.getElementById('planes-module-container');
        const fondoPorTurno = plan.amount * plan.participants.length;
        const totalManejado = fondoPorTurno * plan.participants.length;
        const cicloActual = plan.cycles[plan.currentCycle - 1];

        let ciclosHtml = plan.cycles.map((cycle, index) => `
            <div class="cycle-item ${cycle.paid ? 'paid' : ''} ${index + 1 === plan.currentCycle ? 'current' : ''}">
                <div class="cycle-item-header">
                    <span>Turno ${index + 1}: ${cycle.receptor}</span>
                    <span>${cycle.paid ? 'Pagado ✅' : (index + 1 === plan.currentCycle ? 'En curso...' : 'Pendiente')}</span>
                </div>
                <div class="cycle-item-date">Fecha de Pago: ${new Date(cycle.date).toLocaleDateString()}</div>
            </div>
        `).join('');

        container.innerHTML = `
            <div style="margin-bottom: 15px;">
                <button class="back-btn-header" onclick="renderizarPlanesLista()">← Volver a la Lista de Planes</button>
            </div>
            <div class="plan-card">
                <div class="plan-card-title">${plan.name}</div>
                <div class="summary-item"><span>Estado:</span><span class="status status-${plan.status}">${plan.status}</span></div>
                <div class="summary-item"><span>Participantes:</span><span>${plan.participants.length}</span></div>
                <div class="summary-item"><span>Fondo por Turno:</span><span>${simboloMoneda}${fondoPorTurno.toFixed(2)}</span></div>
                <div class="summary-item"><span>Total Manejado:</span><span>${simboloMoneda}${totalManejado.toFixed(2)}</span></div>
            </div>
            
            ${plan.status === 'active' && cicloActual ? `
            <div class="plan-card" style="border-left: 5px solid var(--success-color);">
                <div class="plan-card-title">Turno Actual: ${plan.currentCycle}</div>
                <p>Es el turno de <strong>${cicloActual.receptor}</strong>.</p>
                <p style="color: #555; font-size: 0.9em;">Vence el: ${new Date(cicloActual.date).toLocaleDateString()}</p>
                <button class="btn btn-success" style="width: 100%;" onclick="marcarPlanComoPagado('${plan.id}')">Marcar como Pagado</button>
            </div>
            ` : ''}

            ${plan.status === 'completado' ? `
            <div class="plan-card" style="background-color: #e8f5e9; text-align: center;">
                 <div class="plan-card-title">🎉 ¡Plan Completado! 🎉</div>
                 <p>Todos los turnos han sido pagados.</p>
            </div>
            ` : ''}

            <div class="plan-card">
                <div class="plan-card-title">Progreso de los Turnos</div>
                <div id="cycles-progress-container">${ciclosHtml}</div>
            </div>
        `;
    }

    function marcarPlanComoPagado(planId) {
        const planIndex = datos.planes.findIndex(p => p.id === planId);
        if(planIndex === -1) return;

        const plan = datos.planes[planIndex];
        const cicloActualIndex = plan.currentCycle - 1;
        
        if (plan.cycles[cicloActualIndex] && !plan.cycles[cicloActualIndex].paid) {
            plan.cycles[cicloActualIndex].paid = true;
            plan.currentCycle++;
            if (plan.currentCycle > plan.cycles.length) {
                plan.status = 'completado';
            }
            datos.planes[planIndex] = plan;
            guardarDatos('planes');
            renderizarDetallePlan(planId);
        }
    }

    function calcularFechaPagoPlan(fechaInicio, frecuencia, numeroCiclo) {
        const fecha = new Date(fechaInicio + 'T00:00:00'); // Ensure it's parsed as local time
        let intervaloDias = 0;
        if (frecuencia === 'Semanal') intervaloDias = 7;
        else if (frecuencia === 'Quincenal') intervaloDias = 15;
        
        if (frecuencia === 'Mensual') {
            fecha.setMonth(fecha.getMonth() + (numeroCiclo - 1));
        } else {
            fecha.setDate(fecha.getDate() + (intervaloDias * (numeroCiclo - 1)));
        }
        return fecha.toISOString();
    }


    // --- MODALES ---
    function cerrarModal(modalId) { 
        document.getElementById(modalId).style.display = 'none';
        if(modalId === 'modal-producto') {
            imagenBase64 = null;
        }
        if(modalId === 'modal-pago') {
            pagosTemporales = [];
        }
    }
    function cerrarModalEditarFactura() {
        document.getElementById('modal-editar-factura').style.display = 'none';
    }
    window.onclick = function(event) { if (event.target.className === 'modal') { event.target.style.display = 'none'; } }

    // --- INICIALIZACIÓN ---
    document.addEventListener('DOMContentLoaded', () => {
        // This logic is now handled by React's useEffect in the App component
        // The old code is kept for reference but will be superseded by the React app
        
        if (!document.getElementById('root').hasChildNodes()) {
            // Fallback for non-React environment or if React fails to load
            console.warn("React root not found or empty, running legacy script.");
            document.getElementById('root').style.display = 'none';
            document.getElementById('auth-container').style.display = 'flex';
            cargarDatos();
            verificarSesion();
        } else {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-app-container').style.display = 'none';
        }


        // Event listeners for legacy modals (might be replaced by React state management)
        document.addEventListener('keydown', handleCalculatorKeyboard);

        document.getElementById('producto-imagen').addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (file) {
                try {
                    imagenBase64 = await procesarImagen(file);
                    document.getElementById('imagen-preview').src = imagenBase64;
                    document.getElementById('imagen-preview').style.display = 'block';
                } catch (error) {
                    mostrarNotificacion('Error al procesar la imagen.', 'error');
                }
            }
        });

        document.getElementById('buscar-producto').addEventListener('input', buscarProductosDebounced);
        document.getElementById('buscar-cliente').addEventListener('input', buscarClientesDebounced);
        document.getElementById('buscar-inventario').addEventListener('input', debounce((e) => renderizarInventario(e.target.value), 300));
        document.getElementById('buscar-cliente-vista').addEventListener('input', debounce((e) => renderizarClientes(e.target.value), 300));

        document.getElementById('barcode-input').addEventListener('keypress', procesarBarcodeInput);
        document.getElementById('barcode-input').addEventListener('focus', function() { this.classList.add('barcode-scanner-active'); });
        document.getElementById('barcode-input').addEventListener('blur', function() { this.classList.remove('barcode-scanner-active'); });

        ['primary', 'sidebar', 'secondary', 'success', 'danger', 'warning'].forEach(color => {
            const colorInput = document.getElementById(`config-color-${color}`);
            if(colorInput) {
                colorInput.addEventListener('input', function(e) {
                    document.getElementById(`config-color-${color}-text`).value = e.target.value;
                });
            }
        });
        
        document.getElementById('buscar-cxc').addEventListener('input', debounce(renderizarCxC, 300));
        
        document.getElementById('nueva-tasa-cambio').addEventListener('input', function(e) {
            const valor = parseFloat(e.target.value);
            if (!isNaN(valor)) {
                document.getElementById('equivalente-100').textContent = (valor * 100).toFixed(2);
            }
        });

        document.getElementById('pago-monto-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                agregarPago();
            }
        });

        document.querySelectorAll('.calc-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                const { key } = event.currentTarget.dataset;
                if (key >= '0' && key <= '9') inputDigit(key);
                else if (key === '.') inputDecimal(key);
                else if (key === 'Enter') handleOperator('=');
                else if (key === 'Escape') resetCalculator();
                else if (key === 'Backspace') deleteLastDigit();
                else if (['+', '-', '*', '/'].includes(key)) handleOperator(key);
            });
        });
    });

</script>

<script type="module" src="/index.tsx"></script>
</body>
</html>
